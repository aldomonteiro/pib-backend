{"version":3,"sources":["../../../src/api/controllers/flavorsController.js"],"names":["flavor_get_all","req","res","sortObj","query","sort","rangeObj","range","options","offset","limit","lean","leanWithId","currentUser","activePage","Flavor","find","pageId","cacheToppings","Array","paginate","err","result","status","json","message","errmsg","setHeader","util","format","total","i","docs","length","toppings","tn","k","topping","flavor_get_one","params","id","findOne","doc","errMsg","flavor_create","body","newRecord","flavor","kind","save","then","catch","flavor_update","flavor_delete","findOneAndRemove","getFlavors","pageID","queryFlavor","select","exec","getFlavor","flavorID","getFlavorByName","flavorName","flavors","flavorsNames","push","stringResult","stringSimilarity","findBestMatch","bestMatch","rating","key","indexOf","target","console","log"],"mappings":"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","sourcesContent":["import Flavor from \"../models/flavors\";\nimport util from \"util\";\nimport stringSimilarity from 'string-similarity';\nimport stringCapitalizeName from 'string-capitalize-name';\nimport { configSortQuery, configRangeQuery } from '../util/util';\nimport { getToppings } from './toppingsController';\n\n// List all flavors\n// TODO: use filters in the query req.query\nexport const flavor_get_all = async (req, res) => {\n    // Getting the sort from the requisition\n    var sortObj = configSortQuery(req.query.sort);\n    // Getting the range from the requisition\n    var rangeObj = configRangeQuery(req.query.range);\n\n    let options = {\n        offset: rangeObj['offset'],\n        limit: rangeObj['limit'],\n        sort: sortObj,\n        lean: true,\n        leanWithId: false,\n    };\n\n    var query = {};\n\n    if (req.currentUser.activePage) {\n        query = Flavor.find({ pageId: req.currentUser.activePage });\n    }\n\n    var cacheToppings = new Array();\n\n    Flavor.paginate(query, options, async (err, result) => {\n        if (err) {\n            res.status(500).json({ message: err.errmsg });\n        } else {\n            res.setHeader('Content-Range', util.format(\"flavors %d-%d/%d\", rangeObj['offset'], rangeObj['limit'], result.total));\n\n            for (var i = 0; i < result.docs.length; i++) {\n                const tn = await getToppings(result.docs[i].toppings);\n                for (var k = 0; k < tn.length; k++) {\n                    result.docs[i].tn = result.docs[i].tn ? result.docs[i].tn + ' ' + tn[k].topping : tn[k].topping;\n                }\n            }\n            res.status(200).json(result.docs);\n        }\n    });\n};\n\n// List one record by filtering by ID\nexport const flavor_get_one = (req, res) => {\n    if (req.params && req.params.id) {\n\n        const pageId = req.currentUser.activePage ? req.currentUser.activePage : null;\n\n        Flavor.findOne({ pageId: pageId, id: req.params.id }, (err, doc) => {\n            if (err) {\n                res.status(500).json({ message: err.errMsg });\n            }\n            else {\n                res.status(200).json(doc);\n            }\n        });\n    }\n}\n\n// CREATE A NEW RECORD\nexport const flavor_create = (req, res) => {\n    if (req.body) {\n\n        const pageId = req.currentUser.activePage ? req.currentUser.activePage : null;\n\n        const newRecord = new Flavor({\n            id: req.body.id,\n            flavor: stringCapitalizeName(req.body.flavor),\n            kind: req.body.kind,\n            pageId: pageId,\n            toppings: req.body.toppings,\n        });\n\n        newRecord.save()\n            .then((result) => {\n                res.status(200).json(result);\n            })\n            .catch((err) => {\n                res.status(500).json({ message: err.errmsg });\n            });\n    }\n}\n\n// UPDATE\nexport const flavor_update = (req, res) => {\n    if (req.body && req.body.id) {\n\n        const pageId = req.currentUser.activePage;\n\n        Flavor.findOne({ pageId: pageId, id: req.body.id }, (err, doc) => {\n            if (!err) {\n                doc.flavor = stringCapitalizeName(req.body.flavor);\n                doc.kind = req.body.kind;\n                doc.toppings = req.body.toppings;\n\n                doc.save((err, result) => {\n                    if (err) {\n                        res.status(500).json({ message: err.errmsg });\n                    } else {\n                        res.status(200).json(result);\n                    }\n                });\n            } else {\n                res.status(500).json({ message: err.errmsg });\n            }\n        });\n    }\n}\n\n// DELETE\nexport const flavor_delete = (req, res) => {\n\n    const pageId = req.currentUser.activePage;\n\n    Flavor.findOneAndRemove({ pageId: pageId, id: req.params.id })\n        .then((result) => {\n            res.status(200).json(result);\n        })\n        .catch((err) => {\n            res.status(500).json({ message: err.errmsg });\n        });\n};\n\nexport const getFlavors = async (pageID) => {\n    var queryFlavor = Flavor.find({ pageId: pageID });\n    queryFlavor.sort('flavor');\n    queryFlavor.select('id flavor kind toppings');\n    return await queryFlavor.exec();\n}\n\nexport const getFlavor = async (pageID, flavorID) => {\n    var queryFlavor = Flavor.findOne({ pageId: pageID, id: flavorID });\n    queryFlavor.select('id flavor kind');\n    return await queryFlavor.exec();\n}\n\nexport const getFlavorByName = async (pageID, flavorName) => {\n    const flavors = await getFlavors(pageID);\n    var flavorsNames = new Array();\n\n    for (var i = 0; i < flavors.length; i++) {\n        flavorsNames.push(flavors[i].flavor);\n    }\n\n\n    const stringResult = stringSimilarity.findBestMatch(flavorName, flavorsNames);\n    /* stringSimilarity searching for 'Escarola e bacon', result:\n    { ratings:\n        [ { target: 'Quatro queijos', rating: 0.09090909090909091 },\n          { target: 'Frango com Catupiry', rating: 0.16 },\n          { target: 'Escarola', rating: 0.7777777777777778 },\n          { target: 'Escarola com bacon', rating: 0.9166666666666666 } ],\n       bestMatch: { target: 'Escarola com bacon', rating: 0.9166666666666666 } }\n        */\n\n    if (stringResult.bestMatch.rating > 0.6) {\n        const key = flavorsNames.indexOf(stringResult.bestMatch.target);\n        console.log(stringResult, flavorsNames, key, flavors);\n        return flavors[key];\n    } else {\n        return null;\n    }\n}"],"file":"flavorsController.js"}