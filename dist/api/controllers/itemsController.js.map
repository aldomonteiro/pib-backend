{"version":3,"sources":["../../../src/api/controllers/itemsController.js"],"names":["ITEMSTATUS_PENDING","ITEMSTATUS_COMPLETED","updateItem","orderData","orderId","userId","pageId","qty","sizeId","flavorId","completeItem","split","_searchStatus","Items","findOne","status","exec","item","pricing","_qty","price","originalSplit","save","find","select","sort","limit","resultLastId","itemId","length","id","record","updateStatusSpecificItem","objectId","_id","mongoose","Types","ObjectId","getItems","completeItems","queryAuxTables","items","i","flavor","size","getItemsTotal","_total"],"mappings":"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","sourcesContent":["import Items from '../models/items';\nimport mongoose from 'mongoose';\nimport { getFlavor } from './flavorsController';\nimport { getSize } from './sizesController';\nimport { getOnePricingByFlavor } from './pricingsController';\n\n\nconst ITEMSTATUS_PENDING = 0;\nconst ITEMSTATUS_COMPLETED = 1;\n\nexport const updateItem = async orderData => {\n    const { orderId, userId, pageId, qty, sizeId, flavorId, completeItem, split } = orderData;\n\n    if (qty || sizeId || flavorId || typeof completeItem === 'boolean') {\n        let _searchStatus = ITEMSTATUS_PENDING;\n        // Received a completeItem = false from botController, so,\n        // the search is for a completed item.\n        if (typeof completeItem === 'boolean' && !completeItem)\n            _searchStatus = ITEMSTATUS_COMPLETED;\n\n        const item = await Items.findOne({ orderId: orderId, userId: userId, pageId: pageId, status: _searchStatus }).exec();\n        if (item) {\n            if (qty) item.qty = qty;\n            if (sizeId) item.sizeId = sizeId;\n            if (flavorId) item.flavorId = flavorId;\n            if (split) item.split = split;\n            if (typeof completeItem === 'boolean')\n                item.status = completeItem === true ? ITEMSTATUS_COMPLETED : ITEMSTATUS_PENDING;\n\n            if (item.sizeId && item.flavorId) {\n                const pricing = await getOnePricingByFlavor(pageId, item.sizeId, item.flavorId);\n                if (pricing) {\n                    const _qty = item.qty && item.qty > 0 ? item.qty : 1;\n                    item.price = (pricing.price * _qty)\n                    if (item.split && item.split > 1) {\n                        item.price = item.price / item.split;\n                    }\n                }\n            }\n\n            if (qty || sizeId || flavorId || split || originalSplit || typeof completeItem === 'boolean')\n                await item.save();\n        }\n        else {\n            let resultLastId = await Items.find({ pageId: pageId, orderId: orderId }).select('id').sort('-id').limit(1).exec();\n            let itemId = 1;\n            if (resultLastId && resultLastId.length)\n                itemId = resultLastId[0].id + 1;\n\n            const record = new Items({\n                id: itemId,\n                orderId: orderId,\n                userId: userId,\n                pageId: pageId,\n                qty: qty,\n                sizeId: sizeId,\n                flavorId: flavorId,\n                status: ITEMSTATUS_PENDING,\n            });\n            await record.save();\n        }\n    }\n}\n\nexport const updateStatusSpecificItem = async (objectId, status) => {\n    const item = await Items.findOne({ _id: mongoose.Types.ObjectId(objectId) }).exec();\n    if (item) {\n        item.status = status;\n        await item.save();\n    }\n}\n\n/**\n * Return all items from an orderId+pageId with flavor and size.\n * completeItems=true query aux tables. default is true.\n * completeItems=false do not query aux tables.\n * @param {*} orderData \n */\nexport const getItems = async orderData => {\n    const { orderId, pageId, completeItems } = orderData;\n\n    let queryAuxTables = true;\n    if (typeof completeItems !== 'undefined') {\n        queryAuxTables = completeItems;\n    }\n\n    const items = await Items.find({ orderId: orderId, pageId: pageId }).exec();\n    if (items && items.length) {\n        for (let i = 0; i < items.length; i++) {\n            if (items[i].flavorId && items[i].flavorId > 0) {\n                if (queryAuxTables) {\n                    const flavor = await getFlavor(pageId, items[i].flavorId);\n                    if (flavor)\n                        items[i].flavor = flavor.flavor;\n                }\n            }\n\n            if (items[i].sizeId && items[i].sizeId > 0) {\n                if (queryAuxTables) {\n                    const size = await getSize(pageId, items[i].sizeId);\n                    if (size)\n                        items[i].size = size.size;\n                }\n            }\n        }\n        return items;\n    } else {\n        return null;\n    }\n}\n\n/**\n * Calculate total price of an orderId+pageId\n * @param {*} orderData \n */\nexport const getItemsTotal = async orderData => {\n    const { orderId, pageId } = orderData;\n    const items = await getItems({ orderId, pageId, completeItems: false });\n\n    let _total = 0;\n\n    if (items && items.length) {\n        for (const item of items) {\n            _total += item.price ? item.price : 0;\n        }\n    }\n\n    return _total;\n}\n\n"],"file":"itemsController.js"}