{"version":3,"sources":["../../../src/api/controllers/itemsController.js"],"names":["ITEMSTATUS_PENDING","ITEMSTATUS_COMPLETED","deleteManyItems","pageID","Items","deleteMany","pageId","exec","updateItem","orderData","orderId","userId","qty","sizeId","flavorId","beverageId","beveragePrice","completeItem","split","originalSplit","_searchStatus","findOne","status","item","price","pricing","_qty","save","find","select","sort","limit","resultLastId","itemId","length","id","record","updateStatusSpecificItem","objectId","_id","mongoose","Types","ObjectId","getItems","completeItems","queryAuxTables","items","i","flavor","size","beverage","name","getItemsTotal","_total"],"mappings":"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","sourcesContent":["import mongoose from 'mongoose';\nimport Items from '../models/items';\nimport { getFlavor } from './flavorsController';\nimport { getOnePricingByFlavor } from './pricingsController';\nimport { getSize } from './sizesController';\nimport { getBeverage } from './beveragesController';\n\n\nconst ITEMSTATUS_PENDING = 0;\nconst ITEMSTATUS_COMPLETED = 1;\n\n\n/**\n * Delete all records from a pageID\n * @param {*} pageID \n */\nexport const deleteManyItems = async (pageID) => {\n    return await Items.deleteMany({ pageId: pageID }).exec();\n}\n\nexport const updateItem = async orderData => {\n    const { orderId, userId, pageId,\n        qty, sizeId, flavorId,\n        beverageId, beveragePrice, completeItem, split, originalSplit } = orderData;\n\n    if (qty || sizeId || flavorId || beverageId || typeof completeItem === 'boolean') {\n        let _searchStatus = ITEMSTATUS_PENDING;\n        // Received a completeItem = false from botController, so,\n        // the search is for a completed item.\n        if (typeof completeItem === 'boolean' && !completeItem)\n            _searchStatus = ITEMSTATUS_COMPLETED;\n\n        const item = await Items.findOne({ orderId: orderId, userId: userId, pageId: pageId, status: _searchStatus }).exec();\n        if (item) {\n            if (qty) item.qty = qty;\n            if (sizeId) item.sizeId = sizeId;\n            if (flavorId) item.flavorId = flavorId;\n            if (beverageId) {\n                item.qty = 1;\n                item.beverageId = beverageId;\n                item.price = beveragePrice;\n            }\n            if (split) item.split = split;\n            if (typeof completeItem === 'boolean')\n                item.status = completeItem === true ? ITEMSTATUS_COMPLETED : ITEMSTATUS_PENDING;\n\n            if (item.sizeId && item.flavorId) {\n                const pricing = await getOnePricingByFlavor(pageId, item.sizeId, item.flavorId);\n                if (pricing) {\n                    const _qty = item.qty && item.qty > 0 ? item.qty : 1;\n                    item.price = (pricing.price * _qty)\n                    if (item.split && item.split > 1) {\n                        item.price = item.price / item.split;\n                    }\n                }\n            }\n\n            if (qty || sizeId || flavorId || split || beverageId || originalSplit || typeof completeItem === 'boolean')\n                await item.save();\n        }\n        else {\n            let resultLastId = await Items.find({ pageId: pageId, orderId: orderId }).select('id').sort('-id').limit(1).exec();\n            let itemId = 1;\n            if (resultLastId && resultLastId.length)\n                itemId = resultLastId[0].id + 1;\n\n            let price = 0;\n            if (beverageId && beveragePrice) {\n                price = beveragePrice;\n            }\n\n            const record = new Items({\n                id: itemId,\n                orderId: orderId,\n                userId: userId,\n                pageId: pageId,\n                qty: qty,\n                sizeId: sizeId,\n                flavorId: flavorId,\n                beverageId: beverageId,\n                price: price,\n                status: ITEMSTATUS_PENDING,\n            });\n            await record.save();\n        }\n    }\n}\n\nexport const updateStatusSpecificItem = async (objectId, status) => {\n    const item = await Items.findOne({ _id: mongoose.Types.ObjectId(objectId) }).exec();\n    if (item) {\n        item.status = status;\n        await item.save();\n    }\n    return item;\n}\n\n/**\n * Return all items from an orderId+pageId with flavor and size.\n * completeItems=true query aux tables. default is true.\n * completeItems=false do not query aux tables.\n * @param {*} orderData \n */\nexport const getItems = async orderData => {\n    const { orderId, pageId, completeItems } = orderData;\n\n    let queryAuxTables = true;\n    if (typeof completeItems !== 'undefined') {\n        queryAuxTables = completeItems;\n    }\n\n    const items = await Items.find({ orderId: orderId, pageId: pageId }).exec();\n    if (items && items.length) {\n        for (let i = 0; i < items.length; i++) {\n            if (items[i].flavorId && items[i].flavorId > 0) {\n                if (queryAuxTables) {\n                    const flavor = await getFlavor(pageId, items[i].flavorId);\n                    if (flavor)\n                        items[i].flavor = flavor.flavor;\n                }\n            }\n\n            if (items[i].sizeId && items[i].sizeId > 0) {\n                if (queryAuxTables) {\n                    const size = await getSize(pageId, items[i].sizeId);\n                    if (size)\n                        items[i].size = size.size;\n                }\n            }\n\n            if (items[i].beverageId && items[i].beverageId > 0) {\n                if (queryAuxTables) {\n                    const beverage = await getBeverage(pageId, items[i].beverageId);\n                    if (beverage)\n                        items[i].beverage = beverage.name;\n                }\n            }\n        }\n        return items;\n    } else {\n        return null;\n    }\n}\n\n/**\n * Calculate total price of an orderId+pageId\n * @param {*} orderData \n */\nexport const getItemsTotal = async orderData => {\n    const { orderId, pageId } = orderData;\n    const items = await getItems({ orderId, pageId, completeItems: false });\n\n    let _total = 0;\n\n    if (items && items.length) {\n        for (const item of items) {\n            _total += item.price ? item.price : 0;\n        }\n    }\n\n    return _total;\n}\n\n"],"file":"itemsController.js"}