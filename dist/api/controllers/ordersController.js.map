{"version":3,"sources":["../../../src/api/controllers/ordersController.js"],"names":["ORDERSTATUS_PENDING","ORDERSTATUS_CONFIRMED","ORDERSTATUS_CANCELLED","ORDERSTATUS_DELIVERED","updateOrder","orderData","pageId","userId","qty","location","user","phone","addrData","completeItem","confirmOrder","waitingForAddress","first_name","last_name","profile_pic","Order","findOne","status","exec","order","orderId","id","location_lat","lat","location_long","long","location_url","url","qty_total","address","formattedAddress","item_complete","save","find","select","sort","limit","resultLastId","length","console","info","record","saved","error","getOrderPending","isComplete","_order","_items","completeOrder","items","headerOrder"],"mappings":"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","sourcesContent":["import Order from '../models/orders';\nimport { updateItem, getItems } from './itemsController';\nimport { customer_update } from './customersController';\nimport { throwError } from 'rxjs';\n\nconst ORDERSTATUS_PENDING = 0;\nconst ORDERSTATUS_CONFIRMED = 1;\nconst ORDERSTATUS_CANCELLED = 2;\nconst ORDERSTATUS_DELIVERED = 3;\n\nexport const updateOrder = async orderData => {\n    try {\n        const { pageId, userId, qty, location, user, phone, addrData, completeItem, confirmOrder, waitingForAddress } = orderData;\n\n        if (user) {\n            const { first_name, last_name, profile_pic } = user;\n            await customer_update({ pageId, userId, first_name, last_name, profile_pic })\n        } else if (phone) {\n            await customer_update({ pageId, userId, phone })\n        } else if (location) {\n            await customer_update({ pageId, userId, location })\n        } else if (addrData) {\n            await customer_update({ pageId, userId, addrData })\n        }\n\n        const order = await Order.findOne({ pageId: pageId, userId: userId, status: ORDERSTATUS_PENDING }).exec();\n\n        if (order) {\n            orderData.orderId = order.id;\n\n            let updateOrder = false;\n            if (location) {\n                order.location_lat = location.lat;\n                order.location_long = location.long;\n                order.location_url = location.url;\n                updateOrder = true;\n            }\n            if (qty) {\n                order.qty_total = qty;\n                updateOrder = true;\n\n                // order has total quantity.\n                // items are always 1. this variable will be passed to updateItem\n                orderData.qty = 1;\n            }\n            if (phone) {\n                order.phone = phone;\n                updateOrder = true;\n            }\n            if (addrData) {\n                order.address = addrData.formattedAddress;\n                updateOrder = true;\n            }\n\n            if (completeItem) {\n                if (order.item_complete) order.item_complete = order.item_complete + 1;\n                else order.item_complete = 1;\n                updateOrder = true;\n            }\n\n            if (confirmOrder) {\n                order.status = ORDERSTATUS_CONFIRMED;\n                updateOrder = true;\n            }\n\n            if (typeof waitingForAddress === 'boolean') {\n                order.waitingForAddress = waitingForAddress;\n                updateOrder = true;\n            }\n\n            if (updateOrder)\n                await order.save();\n\n            await updateItem(orderData);\n        } else {\n            // const count = await Order.find({ pageId: pageId }).count().exec();\n            // let orderId = 1;\n            // if (count) orderId = count + 1;\n\n            const resultLastId = await Order.find({ pageId: pageId }).select('id').sort('-id').limit(1).exec();\n            let orderId = 1;\n            if (resultLastId && resultLastId.length) orderId = resultLastId[0].id + 1;\n\n            console.info({ resultLastId });\n\n            const record = new Order({\n                id: orderId,\n                pageId: pageId,\n                userId: userId,\n                qty_total: qty ? qty : 0,\n                location_lat: location ? location.lat : null,\n                location_long: location ? location.long : null,\n                location_url: location ? location.url : null,\n                waitingForAddress: typeof waitingForAddress === 'boolean' ? waitingForAddress : false,\n                status: ORDERSTATUS_PENDING,\n            });\n            const saved = await record.save();\n            orderData.orderId = saved.id;\n            await updateItem(orderData);\n        }\n    } catch (error) {\n        console.error(\"Error while updating order\");\n        console.error(error);\n        throwError(error);\n    }\n}\n\nexport const getOrderPending = async orderData => {\n    const { userId, pageId, isComplete } = orderData;\n\n    const _order = await Order.findOne({ userId: userId, pageId: pageId, status: ORDERSTATUS_PENDING }).exec();\n    if (_order) {\n        if (isComplete && isComplete === true) {\n            const _items = await getItems({ orderId: _order.id, pageId: pageId });\n\n            const completeOrder = {\n                order: _order,\n                items: _items,\n            };\n\n            return completeOrder;\n        } else {\n            const headerOrder = {\n                order: _order,\n            }\n            return headerOrder;\n        }\n    } else return null;\n}\n"],"file":"ordersController.js"}