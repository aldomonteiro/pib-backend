{"version":3,"sources":["../../../src/api/controllers/ordersController.js"],"names":["ORDERSTATUS_PENDING","ORDERSTATUS_CONFIRMED","ORDERSTATUS_VIEWED","ORDERSTATUS_ACCEPTED","ORDERSTATUS_PRINTED","ORDERSTATUS_DELIVERED","ORDERSTATUS_FINISHED","ORDERSTATUS_REJECTED","ORDERSTATUS_CANCELLED","order_get_all","req","res","sortObj","query","sort","rangeObj","range","filterObj","filter","queryParam","currentUser","activePage","$gte","filterField","length","i","value","filterValues","Array","isArray","dateIni","DateTime","fromISO","set","hour","minute","second","setZone","dateEnd","invalid","toISO","$lt","$in","date","endsWith","replace","rezonedIni","rezonedEnd","plus","days","Object","values","body","simpleOrder","simpleOrderGetAll","ret","fullOrderGetAll","console","log","setHeader","util","format","rangeIni","rangeEnd","totalCount","status","json","ordersArray","error","orderGetAllErr","message","order_get_one","params","id","pageId","getOrderJson","jsonOrder","orderGetOneError","order_update","dir","operation","Order","findOne","doc","updateOrder","rejectionExplanation","sent_reject_notification","local","rejection_reason","userId","store","sendNotification","phone","accept_notification","deliver_notification","missing_address_notification","question","comments","newAddress","newTotal","updatePostComments","closeOrder","totalNotification","address","formatted","isNaN","Number","total","total_notification","toString","postComments","status2","delivered_at","source","sent_shipping_notification","info","save","deleteManyOrders","pageID","deleteMany","exec","orderId","order","customerId","customer","completeItems","items","distanceFromStore","location_lat","location_long","deliverAt","deliver_time","fromJSDate","confirmed_at","minutes","updatedAt","jsonItems","forEach","item","jsonItem","flavorId","sizeId","beverageId","beverage","price","qty","split","flavor","size","push","customerName","first_name","last_name","createdAt","deliver_type","qty_total","status3","payment_type","payment_change","delivery_fee","surcharge_percent","surcharge_amount","getOrderJsonErr","Error","orderData","deliverType","deliverTime","location","user","addrData","completeItem","confirmOrder","waitingForAddress","waitingFor","waitingForData","undo","currentItem","calcTotal","originalSplit","currentItemSplit","eraseSplit","noBeverage","paymentType","paymentChange","backToConfirmation","categoryId","storeAddress","customerID","customerData","profile_pic","currentStatus","calcDistance","calc","lat","location_url","url","formattedAddress","storeData","distance_from_store","delivery_fees","currentItemSize","store_address","item_complete","no_beverage","currentItemCategory","find","select","limit","resultLastId","record","updateOrderError","queryObj","result","offset","asideTotalAmount","asideTotalItems","formattedDistance","toFixed","refDate","deliverd_at","findError","getOrderPending","isComplete","_order","_items","completeOrder","headerOrder","getLastUserOrder","resultLast","getLastOrder","getLastPendingOrders","orders","getOrdersCustomerStat","total_spent","nb_orders","first_order","Date","now","last_order","cancelOrder","findOneAndRemove","err","whatsAppId"],"mappings":"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","sourcesContent":["import Order from '../models/orders';\nimport util from 'util';\nimport { updateItem, getItems, getItemsTotal, cancelItems } from './itemsController';\nimport { updateCustomer, getCustomerById } from './customersController';\nimport { getStoreData, calcDeliveryFee } from './storesController';\nimport {\n    configSortQuery, configRangeQueryNew,\n    configFilterQueryMultiple, distanceBetweenCoordinates, formatAsCurrency,\n} from '../util/util';\nimport { DateTime } from 'luxon';\n// import { Bot, Elements } from 'facebook-messenger-bot';\n// import { getOnePageToken } from './pagesController';\nimport { sendShippingNotification, sendRejectionNotification } from '../bot/botController';\nimport { emitEvent } from './redisController';\nimport { emitEventWhats } from './socketController';\nexport const ORDERSTATUS_PENDING = 0;\nexport const ORDERSTATUS_CONFIRMED = 1;\nexport const ORDERSTATUS_VIEWED = 2;\nexport const ORDERSTATUS_ACCEPTED = 3;\nexport const ORDERSTATUS_PRINTED = 4;\nexport const ORDERSTATUS_DELIVERED = 5;\nexport const ORDERSTATUS_FINISHED = 7;\nexport const ORDERSTATUS_REJECTED = 8;\nexport const ORDERSTATUS_CANCELLED = 9;\n\n// List all orders\n// TODO: use filters in the query req.query\nexport const order_get_all = async (req, res) => {\n    try {\n        const sortObj = configSortQuery(req.query.sort);\n        const rangeObj = configRangeQueryNew(req.query.range);\n        const filterObj = configFilterQueryMultiple(req.query.filter);\n\n        let queryParam = {};\n        if (req.currentUser.activePage) {\n            queryParam['pageId'] = req.currentUser.activePage;\n        }\n\n        queryParam['status'] = { $gte: ORDERSTATUS_CONFIRMED };\n\n        if (!sortObj) {\n            sortObj['status'] = 'ASC';\n        }\n\n        if (filterObj && filterObj.filterField && filterObj.filterField.length) {\n            for (let i = 0; i < filterObj.filterField.length; i++) {\n                let filter = filterObj.filterField[i];\n                const value = filterObj.filterValues[i];\n                if (Array.isArray(value)) {\n                    if (value.length === 2) {\n                        const dateIni = DateTime.fromISO(value[0]).set({ hour: 0, minute: 0, second: 0 }).setZone('UTC');\n                        const dateEnd = DateTime.fromISO(value[1]).set({ hour: 23, minute: 59, second: 59 }).setZone('UTC');\n\n                        if (!dateIni.invalid && !dateEnd.invalid)// is date\n                            queryParam[filter] = { $gte: dateIni.toISO(), $lt: dateEnd.toISO() };\n                        else\n                            queryParam[filter] = { $in: value };\n                    } else\n                        queryParam[filter] = { $in: value };\n                } else {\n                    const date = DateTime.fromISO(value);\n                    if (!date.invalid) { // is a date\n                        // date comes with the current time, so, I am setting it to midnight.\n                        // Mongoose stores data on GMT timezone\n                        if (filter.endsWith('_rangestart')) {\n                            filter = filter.replace('_rangestart', '');\n                            const rezonedIni = date.set({ hour: 0, minute: 0, second: 0 }).setZone('UTC');\n                            queryParam[filter] = { $gte: rezonedIni.toISO() };\n                        } else if (filter.endsWith('_rangeend')) {\n                            filter = filter.replace('_rangeend', '');\n                            const rezonedIni = date.set({ hour: 0, minute: 0, second: 0 }).setZone('UTC');\n                            const rezonedEnd = rezonedIni.plus({ days: 1 });\n                            if (queryParam[filter])\n                                queryParam[filter] = { $gte: Object.values(queryParam[filter])[0], $lt: rezonedEnd.toISO() };\n                            else\n                                queryParam[filter] = { $lt: rezonedEnd.toISO() };\n                        } else {\n                            const rezonedIni = date.set({ hour: 0, minute: 0, second: 0 }).setZone('UTC');\n                            const rezonedEnd = rezonedIni.plus({ days: 1 });\n                            queryParam[filter] = { $gte: rezonedIni.toISO(), $lt: rezonedEnd.toISO() };\n                        }\n                    } else\n                        queryParam[filter] = value;\n                }\n            }\n        }\n\n        let ret;\n        if (req.body.simpleOrder)\n            ret = await simpleOrderGetAll(queryParam, sortObj, rangeObj);\n        else ret = await fullOrderGetAll(queryParam, sortObj, rangeObj);\n\n        console.log('ret from fullOrderGetAll:', ret);\n\n        res.setHeader('Content-Range',\n            util.format('orders %d-%d/%d',\n                ret.rangeIni, ret.rangeEnd, ret.totalCount));\n        res.status(200).json(ret.ordersArray);\n\n    } catch (orderGetAllErr) {\n        console.error({ orderGetAllErr })\n        res.status(500).json({ message: orderGetAllErr.message });\n    }\n};\n\n// List one record by filtering by ID\nexport const order_get_one = async (req, res) => {\n    if (req.params && req.params.id) {\n        try {\n            const pageId = req.currentUser.activePage ? req.currentUser.activePage : null;\n            const jsonOrder = await getOrderJson(pageId, req.params.id);\n            res.status(200).json(jsonOrder);\n        } catch (orderGetOneError) {\n            console.error({ orderGetOneError });\n            res.status(500).json({ message: orderGetOneError.message });\n        }\n    }\n}\n\n// UPDATE\nexport const order_update = async (req, res) => {\n    if (req.body && req.body.id) {\n        try {\n            console.dir(req.body);\n            const { id, operation } = req.body;\n            const pageId = req.currentUser.activePage;\n            const doc = await Order.findOne({ pageId: pageId, id: id });\n\n            let updateOrder = true;\n\n            if (operation === 'REJECT') {\n                const { rejectionExplanation } = req.body;\n\n                doc.status = ORDERSTATUS_REJECTED;\n                doc.sent_reject_notification = DateTime.local();\n                doc.rejection_reason = rejectionExplanation;\n                sendRejectionNotification(doc.pageId, doc.userId, doc.id, rejectionExplanation);\n            } else if (operation === 'VIEW') {\n                doc.status = ORDERSTATUS_VIEWED;\n                // sendRejectionNotification(doc.pageId, doc.userId, doc.id, rejectionExplanation);\n            } else if (operation === 'ACCEPT') {\n                doc.status = ORDERSTATUS_ACCEPTED;\n                const store = await getStoreData(doc.pageId);\n                sendNotification(store.phone, doc.userId, store.accept_notification);\n            } else if (operation === 'PRINT') {\n                doc.status = ORDERSTATUS_PRINTED;\n                // sendRejectionNotification(doc.pageId, doc.userId, doc.id, rejectionExplanation);\n            } else if (operation === 'DELIVER') {\n                doc.status = ORDERSTATUS_DELIVERED;\n                const store = await getStoreData(doc.pageId);\n                if (store.deliver_notification)\n                    sendNotification(store.phone, doc.userId, store.deliver_notification);\n            } else if (operation === 'MISSING_ADDRESS') {\n                updateOrder = false;\n                const store = await getStoreData(doc.pageId);\n                sendNotification(store.phone, doc.userId, store.missing_address_notification);\n            } else if (operation === 'OPEN_QUESTION') {\n                const { question } = req.body;\n                doc.comments = doc.comments + '\\n' + question;\n                const store = await getStoreData(doc.pageId);\n                sendNotification(store.phone, doc.userId, question);\n            } else if (operation === 'UPDATE_ORDER_DATA') {\n                const { newAddress, newTotal, updatePostComments, closeOrder, totalNotification } = req.body;\n                if (newAddress)\n                    doc.address = newAddress;\n                else if (newTotal) {\n                    const formatted = newTotal.replace(',', '.')\n                    if (!isNaN(Number(formatted))) {\n                        doc.total = Number(formatted);\n\n                        if (totalNotification) {\n                            const store = await getStoreData(doc.pageId);\n\n                            if (store.total_notification) {\n                                const message = store.total_notification.toString().replace('$TOTAL', formatAsCurrency(doc.total))\n                                sendNotification(store.phone, doc.userId, message);\n                            }\n                        }\n                    } else {\n                        res.status(500).json({ message: 'pos.orders.messages.invalidTotal' });\n                        return\n                    }\n                } else if (updatePostComments) {\n                    if (updatePostComments === 'MERGE') {\n                        doc.comments = doc.comments + '\\n' + doc.postComments;\n                        doc.postComments = null;\n                    } else if (updatePostComments === 'DELETE') {\n                        doc.postComments = null;\n                    }\n                } else if (closeOrder) {\n                    doc.status = ORDERSTATUS_FINISHED;\n                }\n            } else {\n                if (req.body.status2 === 'ordered') {\n                    doc.status = ORDERSTATUS_CONFIRMED;\n                } else if (req.body.status2 === 'delivered') {\n                    doc.status = ORDERSTATUS_DELIVERED;\n                    doc.delivered_at = DateTime.local();\n                } else if (req.body.status2 === 'cancelled') {\n                    doc.status = ORDERSTATUS_DELIVERED;\n                }\n                if (doc.status === ORDERSTATUS_DELIVERED) {\n                    if (doc.source !== 'whatsapp') {\n                        if (!doc.sent_shipping_notification) {\n                            console.info('I am going to send to ' + doc.userId + ', about the order number:' + doc.id + ' a shipping notification');\n                            await sendShippingNotification(doc.pageId, doc.userId, doc.id);\n                            doc.sent_shipping_notification = DateTime.local();\n                        }\n                    }\n                }\n            }\n            if (updateOrder)\n                await doc.save();\n            const jsonOrder = await getOrderJson(pageId, doc.id);\n            res.status(200).json(jsonOrder);\n        } catch (orderUpdateErr) {\n            console.error(orderUpdateErr);\n            res.status(500).json({ message: orderUpdateErr.message });\n        }\n    }\n}\n\n/**\n * Delete all records from a pageID\n * @param {*} pageID\n */\nexport const deleteManyOrders = async (pageID) => {\n    return await Order.deleteMany({ pageId: pageID }).exec();\n}\n\n// export const sendShippingNotification = async order => {\n//     const { accessToken } = await getOnePageToken(order.pageId);\n\n//     const _txt = 'O seu pedido nmero ' + order.id + ' acabou de sair para entrega. Bom apetite!';\n\n//     const out = new Elements();\n//     out.add({ text: _txt });\n//     await Bot.send_message_tag(accessToken, order.userId, out);\n// }\n\n// List one record by filtering by ID\nexport const getOrderJson = async (pageId, orderId) => {\n    try {\n        const order = await Order.findOne({ pageId: pageId, id: orderId });\n        const customer = await getCustomerById(pageId, order.customerId);\n        const items = await getItems({ pageId: pageId, orderId: orderId, completeItems: true });\n        const store = await getStoreData(order.pageId);\n        const distanceFromStore = distanceBetweenCoordinates(store.location_lat, store.location_long, order.location_lat, order.location_long);\n        const deliverAt = order.deliver_time\n            ? DateTime.fromJSDate(order.confirmed_at).plus({ minutes: order.deliver_time })\n            : order.updatedAt;\n        let jsonItems = [];\n        if (items && items.length > 0) {\n            items.forEach(item => {\n                let jsonItem = {\n                    id: item.id,\n                    flavorId: item.flavorId,\n                    sizeId: item.sizeId,\n                    beverageId: item.beverageId,\n                    beverage: item.beverage,\n                    price: item.price,\n                    qty: item.qty,\n                    split: item.split,\n                    flavor: item.flavor,\n                    size: item.size,\n                }\n                jsonItems.push(jsonItem);\n            });\n        }\n        let jsonOrder = {\n            id: order.id,\n            customerId: order.customerId,\n            customerName: customer.first_name + ' ' + customer.last_name,\n            createdAt: order.createdAt,\n            updatedAt: order.updatedAt,\n            deliverAt: deliverAt,\n            confirmed_at: order.confirmed_at,\n            delivered_at: order.delivered_at,\n            deliver_type: order.deliver_type,\n            deliver_time: order.deliver_time,\n            qty_total: order.qty_total,\n            status: order.status,\n            status2: order.status2,\n            status3: order.status3,\n            phone: order.phone,\n            address: order.address,\n            total: order.total,\n            items: jsonItems,\n            distanceFromStore: distanceFromStore,\n            location_lat: order.location_lat,\n            location_long: order.location_long,\n            payment_type: order.payment_type,\n            payment_change: order.payment_change,\n            comments: order.comments,\n            postComments: order.postComments,\n            delivery_fee: order.delivery_fee,\n            surcharge_percent: order.surcharge_percent,\n            surcharge_amount: order.surcharge_amount,\n        }\n        return jsonOrder;\n    } catch (getOrderJsonErr) {\n        console.error({ getOrderJsonErr });\n        throw new Error(getOrderJsonErr.message);\n    }\n}\n\n\nexport const updateOrder = async orderData => {\n    try {\n        const { pageId, userId, source, deliverType, deliverTime, qty, qty_total, location, user,\n            phone, addrData, completeItem, confirmOrder,\n            waitingForAddress, waitingFor, waitingForData, undo, currentItem, sizeId, calcTotal,\n            originalSplit, split, currentItemSplit, eraseSplit, noBeverage,\n            paymentType, paymentChange, backToConfirmation, comments, postComments,\n            categoryId, surcharge_percent, surcharge_amount,\n            storeAddress } = orderData;\n\n        let customerID = 0;\n        let customerData = {}\n        customerData.pageId = pageId;\n        customerData.userId = userId;\n        if (user) {\n            const { first_name, last_name, profile_pic } = user;\n            customerData.first_name = first_name;\n            customerData.last_name = last_name;\n            customerData.profile_pic = profile_pic;\n        }\n        customerData.phone = phone;\n        customerData.location = location;\n        customerData.addrData = addrData;\n        customerID = await updateCustomer(customerData);\n        const order = await Order.findOne({ pageId: pageId, userId: userId, status: { $lt: ORDERSTATUS_DELIVERED } }).exec();\n\n        if (order) {\n            const currentStatus = order.status;\n\n            orderData.orderId = order.id;\n\n            let updateOrder = false;\n\n            let calcDistance = {\n                calc: false,\n                lat: 0,\n                long: 0,\n            }\n\n            if (location) {\n                order.location_lat = location.lat;\n                order.location_long = location.long;\n                order.location_url = location.url;\n                updateOrder = true;\n\n                calcDistance.calc = true;\n                calcDistance.lat = location.lat;\n                calcDistance.long = location.long;\n            }\n\n            if (addrData) {\n                order.address = addrData.formattedAddress;\n                if (addrData.location_lat && addrData.location_long) {\n                    order.location_lat = addrData.location_lat;\n                    order.location_long = addrData.location_long;\n\n                    calcDistance.calc = true;\n                    calcDistance.lat = addrData.location_lat;\n                    calcDistance.long = addrData.location_long;\n                }\n                updateOrder = true;\n            }\n\n            if (calcDistance.calc) {\n                const storeData = await getStoreData(pageId);\n                if (storeData.location_lat && storeData.location_long) {\n                    const distanceFromStore = distanceBetweenCoordinates(storeData.location_lat, storeData.location_long, calcDistance.lat, calcDistance.long)\n                    order.distance_from_store = distanceFromStore;\n                    order.delivery_fee = calcDeliveryFee(storeData.delivery_fees, distanceFromStore);\n                }\n            }\n\n            if (currentItem) {\n                order.currentItem = currentItem;\n                updateOrder = true;\n            }\n\n            if (source) {\n                order.source = source;\n                updateOrder = true;\n            }\n\n            if (qty) {\n                order.qty = qty;\n                updateOrder = true;\n\n                // order has total quantity.\n                // items are always 1. this variable will be passed to updateItem\n                orderData.qty = 1;\n            }\n\n            if (deliverType) {\n                order.deliver_type = deliverType;\n                updateOrder = true;\n            }\n\n            if (deliverTime) {\n                order.deliver_time = deliverTime;\n                updateOrder = true;\n            }\n\n            if (qty_total) {\n                order.qty_total = qty_total;\n                updateOrder = true;\n            }\n\n            if (originalSplit) {\n                // split increments the items number (+originalSplit)\n                //  and removes 1 (that was the original quantity asked by the user)\n                order.qty_total = order.qty_total + originalSplit - 1;\n                // saving the originalSplit in the order and...\n                order.originalSplit = originalSplit;\n                // ...always saving the split as originalSplit in item.\n                // because the split in the order will be decreased until 1\n                orderData.split = originalSplit;\n                updateOrder = true;\n            }\n\n            // starts from 1 until originalSplit\n            if (currentItemSplit) {\n                order.currentItemSplit = currentItemSplit;\n                updateOrder = true;\n            }\n\n            // originalSplit is passed as parameter only once: when user choose the\n            // split division. split is passed as the same value as originalSplit, so, here\n            // I am changing the quantity to assure the item will receive correct data.\n            // originalSplit changes the quantity, so, it can't be passed more than once.\n            if (split) {\n                orderData.sizeId = order.currentItemSize;\n                orderData.qty = 1;\n            }\n\n            // eraseSplit is sent when I am gonna ask the user\n            // about the next pizza.\n            if (eraseSplit) {\n                order.originalSplit = null;\n                order.currentItemSplit = null;\n                updateOrder = true;\n            }\n\n            if (customerID > 0) {\n                order.customerId = customerID;\n                updateOrder = true;\n            }\n\n            if (phone) {\n                order.phone = phone;\n                updateOrder = true;\n            }\n\n            if (sizeId) {\n                order.currentItemSize = sizeId;\n                updateOrder = true;\n            }\n\n            if (surcharge_percent) {\n                order.surcharge_percent = surcharge_percent / 100;\n                updateOrder = true;\n            }\n\n            if (surcharge_amount) {\n                order.surcharge_amount = surcharge_amount;\n                updateOrder = true;\n            }\n\n            if (storeAddress) {\n                order.store_address = storeAddress;\n                updateOrder = true;\n            }\n\n            /** EraseSize only in the item, because, user can navigate through categories\n             * of the same size.\n             */\n            // if (eraseSize) {\n            //     order.currentItemSize = null;\n            // }\n\n            if (completeItem) {\n                if (order.item_complete) order.item_complete = order.item_complete + 1;\n                else order.item_complete = 1;\n                updateOrder = true;\n            }\n\n            if (confirmOrder) {\n                if (order.status < ORDERSTATUS_CONFIRMED) {\n                    order.status = ORDERSTATUS_CONFIRMED;\n                    order.confirmed_at = DateTime.local();\n                    updateOrder = true;\n                }\n            } else {\n                // when updateorder with flavor, I dont have neither split nor originalSplit\n                // but, if the order has an originalSplit, I am going to send it to the item.\n                // This code should run only if I am not confirming the order.\n                if (order.originalSplit && order.originalSplit > 1) {\n                    orderData.split = order.originalSplit;\n                    updateOrder = true;\n                }\n            }\n\n            if (typeof waitingForAddress === 'boolean') {\n                order.waitingForAddress = waitingForAddress;\n                updateOrder = true;\n            }\n\n            if (waitingFor) {\n                order.waitingFor = waitingFor;\n                updateOrder = true;\n\n                if (!undo)\n                    order.undo = null;\n            }\n\n            if (waitingForData) {\n                order.waitingForData = waitingForData;\n                updateOrder = true;\n            }\n\n            if (undo) {\n                order.undo = undo;\n                updateOrder = true;\n            }\n\n            if (backToConfirmation) {\n                order.backToConfirmation = backToConfirmation;\n                updateOrder = true;\n            }\n\n            if (comments) {\n                order.comments = comments;\n                updateOrder = true;\n            }\n\n            if (postComments) {\n                order.postComments = postComments;\n                updateOrder = true;\n            }\n\n            if (typeof calcTotal === 'boolean') {\n                let total = await getItemsTotal({ orderId: order.id, pageId: order.pageId });\n                if (order.delivery_fee > 0) total += order.delivery_fee;\n                if (order.surcharge_percent > 0) total += total * order.surcharge_percent;\n                if (order.surcharge_amount > 0) total += order.surcharge_amount;\n\n                if (total > 0 && total !== order.total) {\n                    order.total = total;\n                    updateOrder = true;\n                }\n            }\n\n            if (typeof noBeverage === 'boolean') {\n                order.no_beverage = noBeverage;\n                updateOrder = true;\n            }\n\n            if (paymentType) {\n                order.payment_type = paymentType;\n                updateOrder = true;\n            }\n\n            if (paymentChange) {\n                order.payment_change = paymentChange;\n                updateOrder = true;\n            }\n\n            if (categoryId) {\n                order.currentItemCategory = categoryId;\n                updateOrder = true;\n            }\n\n            if (updateOrder)\n                await order.save();\n\n            await updateItem(orderData);\n\n            if (confirmOrder || comments || postComments) {\n                // every time new comments are stores I am passing the confirmOrder parameter. So,\n                // here I check if this order was not already confirmed.\n                if (confirmOrder && currentStatus < ORDERSTATUS_CONFIRMED)\n                    emitEvent(pageId, 'new-order', order);\n                else if (comments || postComments)\n                    emitEvent(pageId, 'new-comment', order);\n            }\n\n        } else {\n            // const count = await Order.find({ pageId: pageId }).count().exec();\n            // let orderId = 1;\n            // if (count) orderId = count + 1;\n\n            const resultLastId = await Order.find({ pageId: pageId }).select('id').sort('-id').limit(1).exec();\n            let orderId = 1;\n            if (resultLastId && resultLastId.length) orderId = resultLastId[0].id + 1;\n\n            const record = new Order({\n                id: orderId,\n                pageId: pageId,\n                userId: userId,\n                waitingFor: waitingFor,\n                comments: comments,\n                status: ORDERSTATUS_PENDING,\n            });\n            await record.save();\n            orderData.orderId = record.id;\n            await updateItem(orderData);\n        }\n    } catch (updateOrderError) {\n        console.error({ updateOrderError });\n        throw updateOrderError;\n    }\n}\n\nconst fullOrderGetAll = async (queryObj, sortObj, rangeObj) => {\n    try {\n\n        const ret = {\n            rangeIni: 0,\n            rangeEnd: 0,\n            totalCount: 0,\n            ordersArray: [],\n        }\n\n        const result = await Order.find(queryObj).sort(sortObj).exec();\n\n        ret.rangeIni = 0;\n        ret.rangeEnd = result.length;\n        if (rangeObj) {\n            ret.rangeIni = rangeObj.offset <= result.length ? rangeObj.offset : result.length;\n            ret.rangeEnd = (rangeObj.offset + rangeObj.limit) <= result.length ? rangeObj.offset + rangeObj.limit : result.length;\n        }\n        ret.totalCount = result.length;\n        ret.ordersArray = [];\n        if (result && result.length && result.length > 0) {\n\n            // workaround to show totalamount and totalitems in the frontend, because\n            // I am only sending part of the list (pagination)\n            let asideTotalAmount = 0;\n            let asideTotalItems = result.length;\n            for (const order of result) {\n                asideTotalAmount = asideTotalAmount + order.total;\n            }\n            // workaround end: all orders will receive these values.\n\n            const store = await getStoreData(result[0].pageId);\n            for (let i = ret.rangeIni; i < ret.rangeEnd; i++) {\n                const order = result[i];\n                const items = await getItems({ orderId: order.id, pageId: order.pageId, completeItems: false });\n                const distanceFromStore = distanceBetweenCoordinates(store.location_lat, store.location_long, order.location_lat, order.location_long);\n                let formattedDistance;\n                if (distanceFromStore < 1) {\n                    formattedDistance = (distanceFromStore * 100).toFixed(2) + ' m';\n                } else {\n                    formattedDistance = distanceFromStore.toFixed(2) + ' km';\n                }\n\n                const refDate = order.confirmed_at || order.createdAt;\n\n                const deliverAt = order.deliver_time\n                    ? DateTime.fromJSDate(refDate).plus({ minutes: order.deliver_time })\n                    : refDate;\n\n                let jsonOrder = {\n                    id: order.id,\n                    pageId: order.pageId,\n                    customerId: order.customerId,\n                    userId: order.userId,\n                    phone: order.phone,\n                    deliverAt: deliverAt,\n                    deliver_type: order.deliver_type,\n                    deliver_time: order.deliver_time,\n                    address: order.address,\n                    status: order.status,\n                    status2: order.status2,\n                    status3: order.status3,\n                    qty_total: order.qty_total,\n                    total: order.total,\n                    createdAt: order.createdAt,\n                    updatedAt: order.updatedAt,\n                    items: items,\n                    distanceFromStore: formattedDistance,\n                    location_lat: order.location_lat,\n                    location_long: order.location_long,\n                    confirmed_at: order.confirmed_at,\n                    deliverd_at: order.delivered_at,\n                    payment_type: order.payment_type,\n                    payment_change: order.payment_change,\n                    comments: order.comments,\n                    postComments: order.postComments,\n                    delivery_fee: order.delivery_fee,\n                    surcharge_percent: order.surcharge_percent,\n                    surcharge_amount: order.surcharge_amount,\n                    asideTotalAmount: asideTotalAmount,\n                    asideTotalItems: asideTotalItems,\n                }\n                ret.ordersArray.push(jsonOrder);\n            }\n        }\n        return ret;\n    } catch (error) {\n\n    }\n}\n\nconst simpleOrderGetAll = async (query, sort, rangeObj) => {\n    let ret = {\n        rangeIni: 0,\n        rangeEnd: 0,\n        totalCount: 0,\n        ordersArray: [],\n    }\n\n    Order.find(query).sort(sort).exec(async (findError, result) => {\n        if (findError) {\n            console.error({ findError });\n            throw new Error(findError.message);\n        } else {\n            ret.rangeIni = 0;\n            ret.rangeEnd = result.length;\n            if (rangeObj) {\n                ret.rangeIni = rangeObj.offset <= result.length ? rangeObj.offset : result.length;\n                ret.rangeEnd = (rangeObj.offset + rangeObj.limit) <= result.length ? rangeObj.offset + rangeObj.limit : result.length;\n            }\n            ret.totalCount = result.length;\n            ret.ordersArray = [];\n            if (result && result.length && result.length > 0) {\n\n                // workaround to show totalamount and totalitems in the frontend, because\n                // I am only sending part of the list (pagination)\n                let asideTotalAmount = 0;\n                let asideTotalItems = result.length;\n                for (const order of result) {\n                    asideTotalAmount = asideTotalAmount + order.total;\n                }\n                // workaround end: all orders will receive these values.\n\n                const store = await getStoreData(result[0].pageId);\n                for (let i = ret.rangeIni; i < ret.rangeEnd; i++) {\n                    const order = result[i];\n                    const items = await getItems({ orderId: order.id, pageId: order.pageId, completeItems: false });\n                    const distanceFromStore = distanceBetweenCoordinates(store.location_lat, store.location_long, order.location_lat, order.location_long);\n                    let formattedDistance;\n                    if (distanceFromStore < 1) {\n                        formattedDistance = (distanceFromStore * 100).toFixed(2) + ' m';\n                    } else {\n                        formattedDistance = distanceFromStore.toFixed(2) + ' km';\n                    }\n                    const deliverAt = order.deliver_time\n                        ? DateTime.fromJSDate(order.confirmed_at).plus({ minutes: order.deliver_time })\n                        : order.confirmed_at;\n\n                    let jsonOrder = {\n                        id: order.id,\n                        pageId: order.pageId,\n                        customerId: order.customerId,\n                        userId: order.userId,\n                        phone: order.phone,\n                        deliverAt: deliverAt,\n                        deliver_type: order.deliver_type,\n                        deliver_time: order.deliver_time,\n                        address: order.address,\n                        status: order.status,\n                        status2: order.status2,\n                        status3: order.status3,\n                        qty_total: order.qty_total,\n                        total: order.total,\n                        createdAt: order.createdAt,\n                        items: items,\n                        distanceFromStore: formattedDistance,\n                        location_lat: order.location_lat,\n                        location_long: order.location_long,\n                        confirmed_at: order.confirmed_at,\n                        deliverd_at: order.delivered_at,\n                        payment_type: order.payment_type,\n                        payment_change: order.payment_change,\n                        comments: order.comments,\n                        delivery_fee: order.delivery_fee,\n                        surcharge_percent: order.surcharge_percent,\n                        surcharge_amount: order.surcharge_amount,\n                        asideTotalAmount: asideTotalAmount,\n                        asideTotalItems: asideTotalItems,\n                    }\n                    ret.ordersArray.push(jsonOrder);\n                }\n            }\n        }\n    });\n\n    return ret;\n}\n\nexport const getOrderPending = async orderData => {\n    const { userId, pageId, isComplete } = orderData;\n\n    const _order = await Order.findOne({\n        userId: userId, pageId: pageId,\n        status: { $lt: ORDERSTATUS_DELIVERED },\n    }).exec();\n    if (_order) {\n        if (isComplete && isComplete === true) {\n            const _items = await getItems({ orderId: _order.id, pageId: pageId, completeItems: isComplete });\n\n            const completeOrder = {\n                order: _order,\n                items: _items,\n            };\n\n            return completeOrder;\n        } else {\n            const headerOrder = {\n                order: _order,\n            }\n            return headerOrder;\n        }\n    } else return null;\n}\n\nexport const getLastUserOrder = async orderData => {\n    const { userId, pageId } = orderData;\n\n    const resultLast = await Order.find({\n        pageId: pageId,\n        userId: userId,\n        status: { $lt: ORDERSTATUS_REJECTED },\n    }).sort('-id').limit(1).exec();\n    if (resultLast && resultLast.length)\n        return resultLast[0];\n    else return null;\n}\n\nexport const getLastOrder = async pageID => {\n    const resultLastId = await Order.find({ pageId: pageID, status: { $gte: ORDERSTATUS_CONFIRMED } }).select('id').sort('-confirmed_at').limit(1).exec();\n    if (resultLastId && resultLastId.length)\n        return resultLastId[0].id;\n    else return 0;\n}\n\nexport const getLastPendingOrders = async pageID => {\n    const orders = await Order.find({ pageId: pageID, status: ORDERSTATUS_CONFIRMED })\n        .select('id confirmed_at')\n        .sort('-confirmed_at')\n        .exec();\n\n    if (orders && orders.length)\n        return orders;\n    else return [];\n}\n\n\nexport const getOrdersCustomerStat = async orderData => {\n    const { pageId, customerId } = orderData;\n\n    const orders = await Order.find({ pageId: pageId, customerId: customerId }).select('createdAt total').sort('createdAt').exec();\n    let total_spent = 0;\n    let nb_orders = 0;\n    let first_order = Date.now();\n    let last_order = null;\n    for (const order of orders) {\n        total_spent += order.total;\n        nb_orders += 1;\n\n        if (first_order >= order.createdAt) {\n            first_order = order.createdAt;\n        }\n        if (last_order <= order.createdAt) {\n            last_order = order.createdAt;\n        }\n    }\n    return { total_spent, nb_orders, first_order, last_order };\n}\n\nexport const cancelOrder = async orderData => {\n    const { pageId, userId } = orderData;\n\n    await Order.findOneAndRemove({ pageId: pageId, userId: userId, status: ORDERSTATUS_PENDING },\n        async (err, res) => {\n            if (!err) {\n                if (res) {\n                    const orderId = res.id;\n                    await cancelItems(pageId, orderId);\n                } else {\n                    console.error('Items from this order shall be deleted manually');\n                    console.info(res);\n                }\n            } else {\n                console.error('Order.findOneAndDelete');\n                console.error(err);\n            }\n        });\n}\n\nconst sendNotification = (whatsAppId, userId, message) => {\n    emitEventWhats(whatsAppId, 'notify', { userId: userId, message: message })\n}\n\n/**\n * Trying to reduce the number of calls to getFlavors and getSizes.\n * @param {*} flavors\n * @param {*} sizes\n * @param {*} orderData\n */\n// const getPerformaticItems = async (flavors, sizes, orderData) => {\n//     orderData.completeItems = false;\n//     let items = await getItems(orderData);\n//     for (let i = 0; i < items.length; i++) {\n//         let item = items[i];\n//         if (flavors[item.flavorId]) {\n//             item.flavor = flavors[item.flavorId];\n//         } else {\n//             const flavor = await getFlavor(orderData.pageId, item.flavorId);\n//             if (flavor) {\n//                 item.flavor = flavors[flavor.id] = flavor.flavor;\n//             }\n//         }\n//         if (sizes[item.sizeId]) {\n//             item.size = sizes[item.sizeId];\n//         } else {\n//             const size = await getSize(orderData.pageId, item.sizeId);\n//             if (size) {\n//                 item.size = sizes[size.id] = size.size;\n//             }\n//         }\n//     }\n//     return items;\n// }\n\n"],"file":"ordersController.js"}