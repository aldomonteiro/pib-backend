{"version":3,"sources":["../../../src/api/controllers/ordersController.js"],"names":["ORDERSTATUS_PENDING","ORDERSTATUS_CONFIRMED","ORDERSTATUS_DELIVERED","ORDERSTATUS_CANCELLED","order_get_all","req","res","sortObj","query","sort","rangeObj","range","filterObj","filter","queryParam","currentUser","activePage","filterField","length","i","value","filterValues","$in","date","DateTime","fromISO","invalid","nextDay","plus","days","$gte","toISODate","$lt","Order","find","exec","findError","result","console","error","status","json","message","_rangeIni","_rangeEnd","offset","limit","_totalCount","ordersArray","Array","order","orderId","id","pageId","items","jsonOrder","customerId","userId","phone","address","status2","qty_total","total","createdAt","push","setHeader","util","format","orderGetAllErr","order_get_one","params","getOrderJson","orderGetOneError","order_update","body","findOne","doc","sent_shipping_notification","info","local","save","jsonItems","forEach","item","jsonItem","flavorId","sizeId","beverageId","beverage","price","qty","split","flavor","size","getOrderJsonErr","Error","updateOrder","orderData","location","user","addrData","completeItem","confirmOrder","waitingForAddress","waitingFor","currentItem","calcTotal","originalSplit","eraseSplit","noBeverage","customerID","customerData","first_name","last_name","profile_pic","location_lat","lat","location_long","long","location_url","url","currentItemSplit","currentItemSize","formattedAddress","item_complete","no_beverage","select","resultLastId","record","updateOrderError","getOrderPending","isComplete","_order","_items","completeOrder","headerOrder","getOrdersCustomerStat","orders","total_spent","nb_orders","first_order","Date","now","last_order"],"mappings":";;;;;;;AAAA;;AACA;;AACA;;AACA;;AACA;;AACA;;AAGA;;;;;;;;AACA,IAAMA,mBAAmB,GAAG,CAA5B;AACA,IAAMC,qBAAqB,GAAG,CAA9B;AACA,IAAMC,qBAAqB,GAAG,CAA9B;AACA,IAAMC,qBAAqB,GAAG,CAA9B,C,CAEA;AACA;;AACO,IAAMC,aAAa;AAAA;AAAA;AAAA;AAAA;AAAA,0BAAG,kBAAOC,GAAP,EAAYC,GAAZ;AAAA;AAAA;AAAA;AAAA;AAAA;AACzB,gBAAI;AACMC,cAAAA,OADN,GACgB,4BAAgBF,GAAG,CAACG,KAAJ,CAAUC,IAA1B,CADhB;AAEMC,cAAAA,QAFN,GAEiB,gCAAoBL,GAAG,CAACG,KAAJ,CAAUG,KAA9B,CAFjB;AAGMC,cAAAA,SAHN,GAGkB,sCAA0BP,GAAG,CAACG,KAAJ,CAAUK,MAApC,CAHlB;AAKIC,cAAAA,UALJ,GAKiB,EALjB;;AAMA,kBAAIT,GAAG,CAACU,WAAJ,CAAgBC,UAApB,EAAgC;AAC5BF,gBAAAA,UAAU,CAAC,QAAD,CAAV,GAAuBT,GAAG,CAACU,WAAJ,CAAgBC,UAAvC;AACH;;AAED,kBAAIJ,SAAS,IAAIA,SAAS,CAACK,WAAvB,IAAsCL,SAAS,CAACK,WAAV,CAAsBC,MAAhE,EAAwE;AACpE,qBAASC,CAAT,GAAa,CAAb,EAAgBA,CAAC,GAAGP,SAAS,CAACK,WAAV,CAAsBC,MAA1C,EAAkDC,CAAC,EAAnD,EAAuD;AAC7CN,kBAAAA,MAD6C,GACpCD,SAAS,CAACK,WAAV,CAAsBE,CAAtB,CADoC;AAE7CC,kBAAAA,KAF6C,GAErCR,SAAS,CAACS,YAAV,CAAuBF,CAAvB,CAFqC;;AAGnD,sBAAI,OAAOC,KAAP,KAAiB,OAArB,EAA8B;AAC1BN,oBAAAA,UAAU,CAACD,MAAD,CAAV,GAAqB;AAAES,sBAAAA,GAAG,EAAEF;AAAP,qBAArB;AACH,mBAFD,MAEO;AACGG,oBAAAA,IADH,GACUC,gBAASC,OAAT,CAAiBL,KAAjB,CADV;;AAEH,wBAAI,CAACG,IAAI,CAACG,OAAV,EAAmB;AAAE;AACXC,sBAAAA,OADS,GACCJ,IAAI,CAACK,IAAL,CAAU;AAAEC,wBAAAA,IAAI,EAAE;AAAR,uBAAV,CADD;AAEff,sBAAAA,UAAU,CAACD,MAAD,CAAV,GAAqB;AAAEiB,wBAAAA,IAAI,EAAEP,IAAI,CAACQ,SAAL,EAAR;AAA0BC,wBAAAA,GAAG,EAAEL,OAAO,CAACI,SAAR;AAA/B,uBAArB;AACH,qBAHD,MAIIjB,UAAU,CAACD,MAAD,CAAV,GAAqBO,KAArB;AACP;AACJ;AACJ;;AAEDa,8BAAMC,IAAN,CAAWpB,UAAX,EAAuBL,IAAvB,CAA4BF,OAA5B,EAAqC4B,IAArC;AAAA;AAAA;AAAA;AAAA;AAAA,wCAA0C,iBAAOC,SAAP,EAAkBC,MAAlB;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA,+BAClCD,SADkC;AAAA;AAAA;AAAA;;AAElCE,0BAAAA,OAAO,CAACC,KAAR,CAAc;AAAEH,4BAAAA,SAAS,EAATA;AAAF,2BAAd;AACA9B,0BAAAA,GAAG,CAACkC,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB;AAAEC,4BAAAA,OAAO,EAAEN,SAAS,CAACM;AAArB,2BAArB;AAHkC;AAAA;;AAAA;AAK9BC,0BAAAA,SAL8B,GAKlB,CALkB;AAM9BC,0BAAAA,SAN8B,GAMlBP,MAAM,CAACnB,MANW;;AAOlC,8BAAIR,QAAJ,EAAc;AACViC,4BAAAA,SAAS,GAAGjC,QAAQ,CAACmC,MAAT,IAAmBR,MAAM,CAACnB,MAA1B,GAAmCR,QAAQ,CAACmC,MAA5C,GAAqDR,MAAM,CAACnB,MAAxE;AACA0B,4BAAAA,SAAS,GAAIlC,QAAQ,CAACmC,MAAT,GAAkBnC,QAAQ,CAACoC,KAA5B,IAAsCT,MAAM,CAACnB,MAA7C,GAAsDR,QAAQ,CAACmC,MAAT,GAAkBnC,QAAQ,CAACoC,KAAjF,GAAyFT,MAAM,CAACnB,MAA5G;AACH;;AACG6B,0BAAAA,WAX8B,GAWhBV,MAAM,CAACnB,MAXS;AAY9B8B,0BAAAA,WAZ8B,GAYhB,IAAIC,KAAJ,EAZgB;AAazB9B,0BAAAA,EAbyB,GAarBwB,SAbqB;;AAAA;AAAA,gCAaVxB,EAAC,GAAGyB,SAbM;AAAA;AAAA;AAAA;;AAcxBM,0BAAAA,KAdwB,GAchBb,MAAM,CAAClB,EAAD,CAdU;AAAA;AAAA,iCAeV,+BAAS;AAAEgC,4BAAAA,OAAO,EAAED,KAAK,CAACE,EAAjB;AAAqBC,4BAAAA,MAAM,EAAEH,KAAK,CAACG;AAAnC,2BAAT,CAfU;;AAAA;AAexBC,0BAAAA,KAfwB;AAgB1BC,0BAAAA,SAhB0B,GAgBd;AACZH,4BAAAA,EAAE,EAAEF,KAAK,CAACE,EADE;AAEZC,4BAAAA,MAAM,EAAEH,KAAK,CAACG,MAFF;AAGZG,4BAAAA,UAAU,EAAEN,KAAK,CAACM,UAHN;AAIZC,4BAAAA,MAAM,EAAEP,KAAK,CAACO,MAJF;AAKZC,4BAAAA,KAAK,EAAER,KAAK,CAACQ,KALD;AAMZC,4BAAAA,OAAO,EAAET,KAAK,CAACS,OANH;AAOZnB,4BAAAA,MAAM,EAAEU,KAAK,CAACV,MAPF;AAQZoB,4BAAAA,OAAO,EAAEV,KAAK,CAACU,OARH;AASZC,4BAAAA,SAAS,EAAEX,KAAK,CAACW,SATL;AAUZC,4BAAAA,KAAK,EAAEZ,KAAK,CAACY,KAVD;AAWZC,4BAAAA,SAAS,EAAEb,KAAK,CAACa,SAXL;AAYZT,4BAAAA,KAAK,EAAEA;AAZK,2BAhBc;AA8B9BN,0BAAAA,WAAW,CAACgB,IAAZ,CAAiBT,SAAjB;;AA9B8B;AAaKpC,0BAAAA,EAAC,EAbN;AAAA;AAAA;;AAAA;AAgClCb,0BAAAA,GAAG,CAAC2D,SAAJ,CAAc,eAAd,EAA+BC,cAAKC,MAAL,CAAY,iBAAZ,EAA+BxB,SAA/B,EAA0CC,SAA1C,EAAqDG,WAArD,CAA/B;AACAzC,0BAAAA,GAAG,CAACkC,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqBO,WAArB;;AAjCkC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,iBAA1C;;AAAA;AAAA;AAAA;AAAA;AAoCH,aA/DD,CA+DE,OAAOoB,cAAP,EAAuB;AACrB9B,cAAAA,OAAO,CAACC,KAAR,CAAc;AAAE6B,gBAAAA,cAAc,EAAdA;AAAF,eAAd;AACA9D,cAAAA,GAAG,CAACkC,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB;AAAEC,gBAAAA,OAAO,EAAE0B,cAAc,CAAC1B;AAA1B,eAArB;AACH;;AAnEwB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAH;;AAAA,kBAAbtC,aAAa;AAAA;AAAA;AAAA,GAAnB,C,CAsEP;;;;;AACO,IAAMiE,aAAa;AAAA;AAAA;AAAA;AAAA;AAAA,0BAAG,kBAAOhE,GAAP,EAAYC,GAAZ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,kBACrBD,GAAG,CAACiE,MAAJ,IAAcjE,GAAG,CAACiE,MAAJ,CAAWlB,EADJ;AAAA;AAAA;AAAA;;AAAA;AAGXC,YAAAA,MAHW,GAGFhD,GAAG,CAACU,WAAJ,CAAgBC,UAAhB,GAA6BX,GAAG,CAACU,WAAJ,CAAgBC,UAA7C,GAA0D,IAHxD;AAAA;AAAA,mBAIOuD,YAAY,CAAClB,MAAD,EAAShD,GAAG,CAACiE,MAAJ,CAAWlB,EAApB,CAJnB;;AAAA;AAIXG,YAAAA,SAJW;AAKjBjD,YAAAA,GAAG,CAACkC,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqBc,SAArB;AALiB;AAAA;;AAAA;AAAA;AAAA;AAOjBjB,YAAAA,OAAO,CAACC,KAAR,CAAc;AAAEiC,cAAAA,gBAAgB;AAAlB,aAAd;AACAlE,YAAAA,GAAG,CAACkC,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB;AAAEC,cAAAA,OAAO,EAAE,aAAiBA;AAA5B,aAArB;;AARiB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAH;;AAAA,kBAAb2B,aAAa;AAAA;AAAA;AAAA,GAAnB,C,CAaP;;;;;AACO,IAAMI,YAAY;AAAA;AAAA;AAAA;AAAA;AAAA,0BAAG,kBAAOpE,GAAP,EAAYC,GAAZ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,kBACpBD,GAAG,CAACqE,IAAJ,IAAYrE,GAAG,CAACqE,IAAJ,CAAStB,EADD;AAAA;AAAA;AAAA;;AAAA;AAGVC,YAAAA,MAHU,GAGDhD,GAAG,CAACU,WAAJ,CAAgBC,UAHf;AAAA;AAAA,mBAIEiB,gBAAM0C,OAAN,CAAc;AAAEtB,cAAAA,MAAM,EAAEA,MAAV;AAAkBD,cAAAA,EAAE,EAAE/C,GAAG,CAACqE,IAAJ,CAAStB;AAA/B,aAAd,CAJF;;AAAA;AAIVwB,YAAAA,GAJU;;AAKhB,gBAAIvE,GAAG,CAACqE,IAAJ,CAASd,OAAT,KAAqB,SAAzB,EAAoC;AAChCgB,cAAAA,GAAG,CAACpC,MAAJ,GAAavC,qBAAb;AACH,aAFD,MAEO,IAAII,GAAG,CAACqE,IAAJ,CAASd,OAAT,KAAqB,WAAzB,EAAsC;AACzCgB,cAAAA,GAAG,CAACpC,MAAJ,GAAatC,qBAAb;AACH,aAFM,MAEA,IAAIG,GAAG,CAACqE,IAAJ,CAASd,OAAT,KAAqB,WAAzB,EAAsC;AACzCgB,cAAAA,GAAG,CAACpC,MAAJ,GAAatC,qBAAb;AACH;;AAXe,kBAaZ0E,GAAG,CAACpC,MAAJ,KAAetC,qBAbH;AAAA;AAAA;AAAA;;AAAA,gBAcP0E,GAAG,CAACC,0BAdG;AAAA;AAAA;AAAA;;AAeRvC,YAAAA,OAAO,CAACwC,IAAR,CAAa,2BAA2BF,GAAG,CAACnB,MAA/B,GAAwC,2BAAxC,GAAsEmB,GAAG,CAACxB,EAA1E,GAA+E,0BAA5F;AAfQ;AAAA,mBAgBF,6CAAyBwB,GAAG,CAACvB,MAA7B,EAAqCuB,GAAG,CAACnB,MAAzC,EAAiDmB,GAAG,CAACxB,EAArD,CAhBE;;AAAA;AAiBRwB,YAAAA,GAAG,CAACC,0BAAJ,GAAiCrD,gBAASuD,KAAT,EAAjC;;AAjBQ;AAAA;AAAA,mBAqBVH,GAAG,CAACI,IAAJ,EArBU;;AAAA;AAAA;AAAA,mBAsBQT,YAAY,CAAClB,MAAD,EAASuB,GAAG,CAACxB,EAAb,CAtBpB;;AAAA;AAsBVG,YAAAA,SAtBU;AAyBhBjD,YAAAA,GAAG,CAACkC,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqBc,SAArB;AAzBgB;AAAA;;AAAA;AAAA;AAAA;AA4BhBjB,YAAAA,OAAO,CAACC,KAAR;AACAjC,YAAAA,GAAG,CAACkC,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB;AAAEC,cAAAA,OAAO,EAAE,aAAeA;AAA1B,aAArB;;AA7BgB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAH;;AAAA,kBAAZ+B,YAAY;AAAA;AAAA;AAAA,GAAlB,C,CAkCP;AACA;AAEA;AAEA;AACA;AACA;AACA;AAEA;;;;;AACO,IAAMF,YAAY;AAAA;AAAA;AAAA;AAAA;AAAA,0BAAG,kBAAOlB,MAAP,EAAeF,OAAf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAEAlB,gBAAM0C,OAAN,CAAc;AAAEtB,cAAAA,MAAM,EAAEA,MAAV;AAAkBD,cAAAA,EAAE,EAAED;AAAtB,aAAd,CAFA;;AAAA;AAEdD,YAAAA,KAFc;AAAA;AAAA,mBAGA,+BAAS;AAAEG,cAAAA,MAAM,EAAEA,MAAV;AAAkBF,cAAAA,OAAO,EAAEA;AAA3B,aAAT,CAHA;;AAAA;AAGdG,YAAAA,KAHc;AAIhB2B,YAAAA,SAJgB,GAIJ,EAJI;AAKpB3B,YAAAA,KAAK,CAAC4B,OAAN,CAAc,UAAAC,IAAI,EAAI;AAClB,kBAAIC,QAAQ,GAAG;AACXhC,gBAAAA,EAAE,EAAE+B,IAAI,CAAC/B,EADE;AAEXiC,gBAAAA,QAAQ,EAAEF,IAAI,CAACE,QAFJ;AAGXC,gBAAAA,MAAM,EAAEH,IAAI,CAACG,MAHF;AAIXC,gBAAAA,UAAU,EAAEJ,IAAI,CAACI,UAJN;AAKXC,gBAAAA,QAAQ,EAAEL,IAAI,CAACK,QALJ;AAMXC,gBAAAA,KAAK,EAAEN,IAAI,CAACM,KAND;AAOXC,gBAAAA,GAAG,EAAEP,IAAI,CAACO,GAPC;AAQXC,gBAAAA,KAAK,EAAER,IAAI,CAACQ,KARD;AASXC,gBAAAA,MAAM,EAAET,IAAI,CAACS,MATF;AAUXC,gBAAAA,IAAI,EAAEV,IAAI,CAACU;AAVA,eAAf;AAYAZ,cAAAA,SAAS,CAACjB,IAAV,CAAeoB,QAAf;AACH,aAdD;AAeI7B,YAAAA,SApBgB,GAoBJ;AACZH,cAAAA,EAAE,EAAEF,KAAK,CAACE,EADE;AAEZI,cAAAA,UAAU,EAAEN,KAAK,CAACM,UAFN;AAGZO,cAAAA,SAAS,EAAEb,KAAK,CAACa,SAHL;AAIZF,cAAAA,SAAS,EAAEX,KAAK,CAACW,SAJL;AAKZrB,cAAAA,MAAM,EAAEU,KAAK,CAACV,MALF;AAMZoB,cAAAA,OAAO,EAAEV,KAAK,CAACU,OANH;AAOZF,cAAAA,KAAK,EAAER,KAAK,CAACQ,KAPD;AAQZC,cAAAA,OAAO,EAAET,KAAK,CAACS,OARH;AASZG,cAAAA,KAAK,EAAEZ,KAAK,CAACY,KATD;AAUZR,cAAAA,KAAK,EAAE2B;AAVK,aApBI;AAAA,8CAgCb1B,SAhCa;;AAAA;AAAA;AAAA;AAkCpBjB,YAAAA,OAAO,CAACC,KAAR,CAAc;AAAEuD,cAAAA,eAAe;AAAjB,aAAd;AAlCoB,kBAmCd,IAAIC,KAAJ,CAAU,aAAgBrD,OAA1B,CAnCc;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAH;;AAAA,kBAAZ6B,YAAY;AAAA;AAAA;AAAA,GAAlB;;;;AAwCA,IAAMyB,WAAW;AAAA;AAAA;AAAA;AAAA;AAAA,0BAAG,kBAAMC,SAAN;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAEX5C,YAAAA,MAFW,GAKkC4C,SALlC,CAEX5C,MAFW,EAEHI,MAFG,GAKkCwC,SALlC,CAEHxC,MAFG,EAEKiC,GAFL,GAKkCO,SALlC,CAEKP,GAFL,EAEUQ,QAFV,GAKkCD,SALlC,CAEUC,QAFV,EAEoBC,IAFpB,GAKkCF,SALlC,CAEoBE,IAFpB,EAGfzC,KAHe,GAKkCuC,SALlC,CAGfvC,KAHe,EAGR0C,QAHQ,GAKkCH,SALlC,CAGRG,QAHQ,EAGEC,YAHF,GAKkCJ,SALlC,CAGEI,YAHF,EAGgBC,YAHhB,GAKkCL,SALlC,CAGgBK,YAHhB,EAIfC,iBAJe,GAKkCN,SALlC,CAIfM,iBAJe,EAIIC,UAJJ,GAKkCP,SALlC,CAIIO,UAJJ,EAIgBC,WAJhB,GAKkCR,SALlC,CAIgBQ,WAJhB,EAI6BnB,MAJ7B,GAKkCW,SALlC,CAI6BX,MAJ7B,EAIqCoB,SAJrC,GAKkCT,SALlC,CAIqCS,SAJrC,EAKff,KALe,GAKkCM,SALlC,CAKfN,KALe,EAKRgB,aALQ,GAKkCV,SALlC,CAKRU,aALQ,EAKOC,UALP,GAKkCX,SALlC,CAKOW,UALP,EAKmBC,UALnB,GAKkCZ,SALlC,CAKmBY,UALnB;AAOfC,YAAAA,UAPe,GAOF,CAPE;AAQfC,YAAAA,YARe,GAQA,EARA;AASnBA,YAAAA,YAAY,CAAC1D,MAAb,GAAsBA,MAAtB;AACA0D,YAAAA,YAAY,CAACtD,MAAb,GAAsBA,MAAtB;;AACA,gBAAI0C,IAAJ,EAAU;AACEa,cAAAA,UADF,GACyCb,IADzC,CACEa,UADF,EACcC,SADd,GACyCd,IADzC,CACcc,SADd,EACyBC,WADzB,GACyCf,IADzC,CACyBe,WADzB;AAENH,cAAAA,YAAY,CAACC,UAAb,GAA0BA,UAA1B;AACAD,cAAAA,YAAY,CAACE,SAAb,GAAyBA,SAAzB;AACAF,cAAAA,YAAY,CAACG,WAAb,GAA2BA,WAA3B;AACH;;AACDH,YAAAA,YAAY,CAACrD,KAAb,GAAqBA,KAArB;AACAqD,YAAAA,YAAY,CAACb,QAAb,GAAwBA,QAAxB;AACAa,YAAAA,YAAY,CAACX,QAAb,GAAwBA,QAAxB;AAnBmB;AAAA,mBAoBA,0CAAgBW,YAAhB,CApBA;;AAAA;AAoBnBD,YAAAA,UApBmB;AAAA;AAAA,mBAqBC7E,gBAAM0C,OAAN,CAAc;AAAEtB,cAAAA,MAAM,EAAEA,MAAV;AAAkBI,cAAAA,MAAM,EAAEA,MAA1B;AAAkCjB,cAAAA,MAAM,EAAExC;AAA1C,aAAd,EAA+EmC,IAA/E,EArBD;;AAAA;AAqBbe,YAAAA,KArBa;;AAAA,iBAuBfA,KAvBe;AAAA;AAAA;AAAA;;AAwBf+C,YAAAA,SAAS,CAAC9C,OAAV,GAAoBD,KAAK,CAACE,EAA1B;AAEI4C,YAAAA,YA1BW,GA0BG,KA1BH;;AA2Bf,gBAAIE,QAAJ,EAAc;AACVhD,cAAAA,KAAK,CAACiE,YAAN,GAAqBjB,QAAQ,CAACkB,GAA9B;AACAlE,cAAAA,KAAK,CAACmE,aAAN,GAAsBnB,QAAQ,CAACoB,IAA/B;AACApE,cAAAA,KAAK,CAACqE,YAAN,GAAqBrB,QAAQ,CAACsB,GAA9B;AACAxB,cAAAA,YAAW,GAAG,IAAd;AACH;;AAED,gBAAIS,WAAJ,EAAiB;AACbvD,cAAAA,KAAK,CAACuD,WAAN,GAAoBA,WAApB;AACAT,cAAAA,YAAW,GAAG,IAAd;AACH;;AAED,gBAAIN,GAAJ,EAAS;AACLxC,cAAAA,KAAK,CAACW,SAAN,GAAkB6B,GAAlB;AACAM,cAAAA,YAAW,GAAG,IAAd,CAFK,CAIL;AACA;;AACAC,cAAAA,SAAS,CAACP,GAAV,GAAgB,CAAhB;AACH,aA9Cc,CAgDf;;;AACA,gBAAI,OAAOC,KAAP,KAAiB,QAArB,EAA+B;AAC3BzC,cAAAA,KAAK,CAACuE,gBAAN,GAAyB9B,KAAzB;AACAM,cAAAA,SAAS,CAACX,MAAV,GAAmBpC,KAAK,CAACwE,eAAzB;AACAzB,cAAAA,SAAS,CAACP,GAAV,GAAgB,CAAhB;AAEAM,cAAAA,YAAW,GAAG,IAAd;AACH;;AAED,gBAAIW,aAAJ,EAAmB;AACf;AACA;AACAzD,cAAAA,KAAK,CAACW,SAAN,GAAkBX,KAAK,CAACW,SAAN,GAAkB8C,aAAlB,GAAkC,CAApD,CAHe,CAIf;;AACAzD,cAAAA,KAAK,CAACyD,aAAN,GAAsBA,aAAtB,CALe,CAMf;AACA;;AACAV,cAAAA,SAAS,CAACN,KAAV,GAAkBgB,aAAlB;AACAX,cAAAA,YAAW,GAAG,IAAd;AACH,aAnEc,CAqEf;AACA;;;AACA,gBAAIY,UAAJ,EAAgB;AACZ1D,cAAAA,KAAK,CAACyD,aAAN,GAAsB,IAAtB;AACAzD,cAAAA,KAAK,CAACuE,gBAAN,GAAyB,IAAzB;AACAzB,cAAAA,YAAW,GAAG,IAAd;AACH;;AAED,gBAAIc,UAAU,GAAG,CAAjB,EAAoB;AAChB5D,cAAAA,KAAK,CAACM,UAAN,GAAmBsD,UAAnB;AACAd,cAAAA,YAAW,GAAG,IAAd;AACH;;AAED,gBAAItC,KAAJ,EAAW;AACPR,cAAAA,KAAK,CAACQ,KAAN,GAAcA,KAAd;AACAsC,cAAAA,YAAW,GAAG,IAAd;AACH;;AACD,gBAAII,QAAJ,EAAc;AACVlD,cAAAA,KAAK,CAACS,OAAN,GAAgByC,QAAQ,CAACuB,gBAAzB;AACA3B,cAAAA,YAAW,GAAG,IAAd;AACH;;AAED,gBAAIV,MAAJ,EAAY;AACRpC,cAAAA,KAAK,CAACwE,eAAN,GAAwBpC,MAAxB;AACAU,cAAAA,YAAW,GAAG,IAAd;AACH;;AAED,gBAAIK,YAAJ,EAAkB;AACd,kBAAInD,KAAK,CAAC0E,aAAV,EAAyB1E,KAAK,CAAC0E,aAAN,GAAsB1E,KAAK,CAAC0E,aAAN,GAAsB,CAA5C,CAAzB,KACK1E,KAAK,CAAC0E,aAAN,GAAsB,CAAtB;AACL5B,cAAAA,YAAW,GAAG,IAAd;AACH;;AAED,gBAAIM,YAAJ,EAAkB;AACdpD,cAAAA,KAAK,CAACV,MAAN,GAAevC,qBAAf;AACA+F,cAAAA,YAAW,GAAG,IAAd;AACH,aAHD,MAGO;AACH;AACA;AACA;AACA,kBAAI9C,KAAK,CAACyD,aAAN,IAAuBzD,KAAK,CAACyD,aAAN,GAAsB,CAAjD,EAAoD;AAChDV,gBAAAA,SAAS,CAACN,KAAV,GAAkBzC,KAAK,CAACyD,aAAxB;AACAX,gBAAAA,YAAW,GAAG,IAAd;AACH;AACJ;;AAED,gBAAI,OAAOO,iBAAP,KAA6B,SAAjC,EAA4C;AACxCrD,cAAAA,KAAK,CAACqD,iBAAN,GAA0BA,iBAA1B;AACAP,cAAAA,YAAW,GAAG,IAAd;AACH;;AAED,gBAAIQ,UAAJ,EAAgB;AACZtD,cAAAA,KAAK,CAACsD,UAAN,GAAmBA,UAAnB;AACAR,cAAAA,YAAW,GAAG,IAAd;AACH;;AA3Hc,kBA6HX,OAAOU,SAAP,KAAqB,SA7HV;AAAA;AAAA;AAAA;;AAAA;AAAA,mBA8HS,oCAAc;AAAEvD,cAAAA,OAAO,EAAED,KAAK,CAACE,EAAjB;AAAqBC,cAAAA,MAAM,EAAEH,KAAK,CAACG;AAAnC,aAAd,CA9HT;;AAAA;AA8HLS,YAAAA,KA9HK;;AA+HX,gBAAIA,KAAK,GAAG,CAAR,IAAaA,KAAK,KAAKZ,KAAK,CAACY,KAAjC,EAAwC;AACpCZ,cAAAA,KAAK,CAACY,KAAN,GAAcA,KAAd;AACAkC,cAAAA,YAAW,GAAG,IAAd;AACH;;AAlIU;AAqIf,gBAAI,OAAOa,UAAP,KAAsB,SAA1B,EAAqC;AACjC3D,cAAAA,KAAK,CAAC2E,WAAN,GAAoBhB,UAApB;AACAb,cAAAA,YAAW,GAAG,IAAd;AACH;;AAxIc,iBA0IXA,YA1IW;AAAA;AAAA;AAAA;;AAAA;AAAA,mBA2IL9C,KAAK,CAAC8B,IAAN,EA3IK;;AAAA;AAAA;AAAA,mBA6IT,iCAAWiB,SAAX,CA7IS;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA,mBAmJYhE,gBAAMC,IAAN,CAAW;AAAEmB,cAAAA,MAAM,EAAEA;AAAV,aAAX,EAA+ByE,MAA/B,CAAsC,IAAtC,EAA4CrH,IAA5C,CAAiD,KAAjD,EAAwDqC,KAAxD,CAA8D,CAA9D,EAAiEX,IAAjE,EAnJZ;;AAAA;AAmJT4F,YAAAA,YAnJS;AAoJX5E,YAAAA,OApJW,GAoJD,CApJC;AAqJf,gBAAI4E,YAAY,IAAIA,YAAY,CAAC7G,MAAjC,EAAyCiC,OAAO,GAAG4E,YAAY,CAAC,CAAD,CAAZ,CAAgB3E,EAAhB,GAAqB,CAA/B;AAEnC4E,YAAAA,MAvJS,GAuJA,IAAI/F,eAAJ,CAAU;AACrBmB,cAAAA,EAAE,EAAED,OADiB;AAErBE,cAAAA,MAAM,EAAEA,MAFa;AAGrBI,cAAAA,MAAM,EAAEA,MAHa;AAIrBI,cAAAA,SAAS,EAAE6B,GAAG,GAAGA,GAAH,GAAS,CAJF;AAKrByB,cAAAA,YAAY,EAAEjB,QAAQ,GAAGA,QAAQ,CAACkB,GAAZ,GAAkB,IALnB;AAMrBC,cAAAA,aAAa,EAAEnB,QAAQ,GAAGA,QAAQ,CAACoB,IAAZ,GAAmB,IANrB;AAOrBC,cAAAA,YAAY,EAAErB,QAAQ,GAAGA,QAAQ,CAACsB,GAAZ,GAAkB,IAPnB;AAQrBjB,cAAAA,iBAAiB,EAAE,OAAOA,iBAAP,KAA6B,SAA7B,GAAyCA,iBAAzC,GAA6D,KAR3D;AASrB/D,cAAAA,MAAM,EAAExC;AATa,aAAV,CAvJA;AAAA;AAAA,mBAkKTgI,MAAM,CAAChD,IAAP,EAlKS;;AAAA;AAmKfiB,YAAAA,SAAS,CAAC9C,OAAV,GAAoB6E,MAAM,CAAC5E,EAA3B;AAnKe;AAAA,mBAoKT,iCAAW6C,SAAX,CApKS;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;AAuKnB3D,YAAAA,OAAO,CAACC,KAAR,CAAc;AAAE0F,cAAAA,gBAAgB;AAAlB,aAAd;AAvKmB;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAH;;AAAA,kBAAXjC,WAAW;AAAA;AAAA;AAAA,GAAjB;;;;AA4KA,IAAMkC,eAAe;AAAA;AAAA;AAAA;AAAA;AAAA,0BAAG,kBAAMjC,SAAN;AAAA;;AAAA;AAAA;AAAA;AAAA;AACnBxC,YAAAA,MADmB,GACYwC,SADZ,CACnBxC,MADmB,EACXJ,MADW,GACY4C,SADZ,CACX5C,MADW,EACH8E,UADG,GACYlC,SADZ,CACHkC,UADG;AAAA;AAAA,mBAGNlG,gBAAM0C,OAAN,CAAc;AAAElB,cAAAA,MAAM,EAAEA,MAAV;AAAkBJ,cAAAA,MAAM,EAAEA,MAA1B;AAAkCb,cAAAA,MAAM,EAAExC;AAA1C,aAAd,EAA+EmC,IAA/E,EAHM;;AAAA;AAGrBiG,YAAAA,MAHqB;;AAAA,iBAIvBA,MAJuB;AAAA;AAAA;AAAA;;AAAA,kBAKnBD,UAAU,IAAIA,UAAU,KAAK,IALV;AAAA;AAAA;AAAA;;AAAA;AAAA,mBAME,+BAAS;AAAEhF,cAAAA,OAAO,EAAEiF,MAAM,CAAChF,EAAlB;AAAsBC,cAAAA,MAAM,EAAEA;AAA9B,aAAT,CANF;;AAAA;AAMbgF,YAAAA,MANa;AAQbC,YAAAA,aARa,GAQG;AAClBpF,cAAAA,KAAK,EAAEkF,MADW;AAElB9E,cAAAA,KAAK,EAAE+E;AAFW,aARH;AAAA,8CAaZC,aAbY;;AAAA;AAebC,YAAAA,WAfa,GAeC;AAChBrF,cAAAA,KAAK,EAAEkF;AADS,aAfD;AAAA,8CAkBZG,WAlBY;;AAAA;AAAA;AAAA;;AAAA;AAAA,8CAoBb,IApBa;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAH;;AAAA,kBAAfL,eAAe;AAAA;AAAA;AAAA,GAArB;;;;AAuBA,IAAMM,qBAAqB;AAAA;AAAA;AAAA;AAAA;AAAA,0BAAG,kBAAMvC,SAAN;AAAA;;AAAA;AAAA;AAAA;AAAA;AACzB5C,YAAAA,MADyB,GACF4C,SADE,CACzB5C,MADyB,EACjBG,UADiB,GACFyC,SADE,CACjBzC,UADiB;AAAA;AAAA,mBAGZvB,gBAAMC,IAAN,CAAW;AAAEmB,cAAAA,MAAM,EAAEA,MAAV;AAAkBG,cAAAA,UAAU,EAAEA;AAA9B,aAAX,EAAuDsE,MAAvD,CAA8D,iBAA9D,EAAiFrH,IAAjF,CAAsF,WAAtF,EAAmG0B,IAAnG,EAHY;;AAAA;AAG3BsG,YAAAA,MAH2B;AAI7BC,YAAAA,WAJ6B,GAIf,CAJe;AAK7BC,YAAAA,SAL6B,GAKjB,CALiB;AAM7BC,YAAAA,WAN6B,GAMfC,IAAI,CAACC,GAAL,EANe;AAO7BC,YAAAA,UAP6B,GAOhB,IAPgB;AAAA;AAAA;AAAA;AAAA;;AAQjC,6BAAoBN,MAApB,uHAA4B;AAAjBvF,cAAAA,KAAiB;AACxBwF,cAAAA,WAAW,IAAIxF,KAAK,CAACY,KAArB;AACA6E,cAAAA,SAAS,IAAI,CAAb;;AAEA,kBAAIC,WAAW,IAAI1F,KAAK,CAACa,SAAzB,EAAoC;AAChC6E,gBAAAA,WAAW,GAAG1F,KAAK,CAACa,SAApB;AACH;;AACD,kBAAIgF,UAAU,IAAI7F,KAAK,CAACa,SAAxB,EAAmC;AAC/BgF,gBAAAA,UAAU,GAAG7F,KAAK,CAACa,SAAnB;AACH;AACJ;;AAlBgC;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAAA;;AAAA;AAAA;;AAAA;AAAA,8CAmB1B;AAAE2E,cAAAA,WAAW,EAAXA,WAAF;AAAeC,cAAAA,SAAS,EAATA,SAAf;AAA0BC,cAAAA,WAAW,EAAXA,WAA1B;AAAuCG,cAAAA,UAAU,EAAVA;AAAvC,aAnB0B;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAH;;AAAA,kBAArBP,qBAAqB;AAAA;AAAA;AAAA,GAA3B","sourcesContent":["import Order from '../models/orders';\nimport util from \"util\";\nimport { updateItem, getItems, getItemsTotal } from './itemsController';\nimport { customer_update } from './customersController';\nimport { configSortQuery, configRangeQueryNew, configFilterQueryMultiple } from '../util/util';\nimport { DateTime } from 'luxon';\n// import { Bot, Elements } from 'facebook-messenger-bot';\n// import { getOnePageToken } from './pagesController';\nimport { sendShippingNotification } from '../bot/botController';\nconst ORDERSTATUS_PENDING = 0;\nconst ORDERSTATUS_CONFIRMED = 1;\nconst ORDERSTATUS_DELIVERED = 2;\nconst ORDERSTATUS_CANCELLED = 9;\n\n// List all orders\n// TODO: use filters in the query req.query\nexport const order_get_all = async (req, res) => {\n    try {\n        const sortObj = configSortQuery(req.query.sort);\n        const rangeObj = configRangeQueryNew(req.query.range);\n        const filterObj = configFilterQueryMultiple(req.query.filter);\n\n        let queryParam = {};\n        if (req.currentUser.activePage) {\n            queryParam['pageId'] = req.currentUser.activePage;\n        }\n\n        if (filterObj && filterObj.filterField && filterObj.filterField.length) {\n            for (let i = 0; i < filterObj.filterField.length; i++) {\n                const filter = filterObj.filterField[i];\n                const value = filterObj.filterValues[i];\n                if (typeof value === 'Array') {\n                    queryParam[filter] = { $in: value };\n                } else {\n                    const date = DateTime.fromISO(value);\n                    if (!date.invalid) { // is a date\n                        const nextDay = date.plus({ days: 1 });\n                        queryParam[filter] = { $gte: date.toISODate(), $lt: nextDay.toISODate() };\n                    } else\n                        queryParam[filter] = value;\n                }\n            }\n        }\n\n        Order.find(queryParam).sort(sortObj).exec(async (findError, result) => {\n            if (findError) {\n                console.error({ findError });\n                res.status(500).json({ message: findError.message });\n            } else {\n                let _rangeIni = 0;\n                let _rangeEnd = result.length;\n                if (rangeObj) {\n                    _rangeIni = rangeObj.offset <= result.length ? rangeObj.offset : result.length;\n                    _rangeEnd = (rangeObj.offset + rangeObj.limit) <= result.length ? rangeObj.offset + rangeObj.limit : result.length;\n                }\n                let _totalCount = result.length;\n                let ordersArray = new Array();\n                for (let i = _rangeIni; i < _rangeEnd; i++) {\n                    const order = result[i];\n                    const items = await getItems({ orderId: order.id, pageId: order.pageId });\n                    let jsonOrder = {\n                        id: order.id,\n                        pageId: order.pageId,\n                        customerId: order.customerId,\n                        userId: order.userId,\n                        phone: order.phone,\n                        address: order.address,\n                        status: order.status,\n                        status2: order.status2,\n                        qty_total: order.qty_total,\n                        total: order.total,\n                        createdAt: order.createdAt,\n                        items: items,\n                    }\n                    ordersArray.push(jsonOrder);\n                }\n                res.setHeader('Content-Range', util.format(\"orders %d-%d/%d\", _rangeIni, _rangeEnd, _totalCount));\n                res.status(200).json(ordersArray);\n            }\n        });\n    } catch (orderGetAllErr) {\n        console.error({ orderGetAllErr })\n        res.status(500).json({ message: orderGetAllErr.message });\n    }\n};\n\n// List one record by filtering by ID\nexport const order_get_one = async (req, res) => {\n    if (req.params && req.params.id) {\n        try {\n            const pageId = req.currentUser.activePage ? req.currentUser.activePage : null;\n            const jsonOrder = await getOrderJson(pageId, req.params.id);\n            res.status(200).json(jsonOrder);\n        } catch (orderGetOneError) {\n            console.error({ orderGetOneError });\n            res.status(500).json({ message: orderGetOneError.message });\n        }\n    }\n}\n\n// UPDATE\nexport const order_update = async (req, res) => {\n    if (req.body && req.body.id) {\n        try {\n            const pageId = req.currentUser.activePage;\n            const doc = await Order.findOne({ pageId: pageId, id: req.body.id });\n            if (req.body.status2 === 'ordered') {\n                doc.status = ORDERSTATUS_CONFIRMED;\n            } else if (req.body.status2 === 'delivered') {\n                doc.status = ORDERSTATUS_DELIVERED;\n            } else if (req.body.status2 === 'cancelled') {\n                doc.status = ORDERSTATUS_DELIVERED;\n            }\n\n            if (doc.status === ORDERSTATUS_DELIVERED) {\n                if (!doc.sent_shipping_notification) {\n                    console.info(\"I am going to send to \" + doc.userId + \", about the order number:\" + doc.id + \" a shipping notification\");\n                    await sendShippingNotification(doc.pageId, doc.userId, doc.id);\n                    doc.sent_shipping_notification = DateTime.local();\n                }\n            }\n\n            await doc.save();\n            const jsonOrder = await getOrderJson(pageId, doc.id);\n\n\n            res.status(200).json(jsonOrder);\n        }\n        catch (orderUpdateErr) {\n            console.error(orderUpdateErr);\n            res.status(500).json({ message: orderUpdateErr.message });\n        }\n    }\n}\n\n// export const sendShippingNotification = async order => {\n//     const { accessToken } = await getOnePageToken(order.pageId);\n\n//     const _txt = 'O seu pedido nÃºmero ' + order.id + ' acabou de sair para entrega. Bom apetite!';\n\n//     const out = new Elements();\n//     out.add({ text: _txt });\n//     await Bot.send_message_tag(accessToken, order.userId, out);\n// }\n\n// List one record by filtering by ID\nexport const getOrderJson = async (pageId, orderId) => {\n    try {\n        const order = await Order.findOne({ pageId: pageId, id: orderId });\n        const items = await getItems({ pageId: pageId, orderId: orderId });\n        let jsonItems = [];\n        items.forEach(item => {\n            let jsonItem = {\n                id: item.id,\n                flavorId: item.flavorId,\n                sizeId: item.sizeId,\n                beverageId: item.beverageId,\n                beverage: item.beverage,\n                price: item.price,\n                qty: item.qty,\n                split: item.split,\n                flavor: item.flavor,\n                size: item.size,\n            }\n            jsonItems.push(jsonItem);\n        });\n        let jsonOrder = {\n            id: order.id,\n            customerId: order.customerId,\n            createdAt: order.createdAt,\n            qty_total: order.qty_total,\n            status: order.status,\n            status2: order.status2,\n            phone: order.phone,\n            address: order.address,\n            total: order.total,\n            items: jsonItems,\n        }\n        return jsonOrder;\n    } catch (getOrderJsonErr) {\n        console.error({ getOrderJsonErr });\n        throw new Error(getOrderJsonErr.message);\n    }\n}\n\n\nexport const updateOrder = async orderData => {\n    try {\n        const { pageId, userId, qty, location, user,\n            phone, addrData, completeItem, confirmOrder,\n            waitingForAddress, waitingFor, currentItem, sizeId, calcTotal,\n            split, originalSplit, eraseSplit, noBeverage } = orderData;\n\n        let customerID = 0;\n        let customerData = {}\n        customerData.pageId = pageId;\n        customerData.userId = userId;\n        if (user) {\n            const { first_name, last_name, profile_pic } = user;\n            customerData.first_name = first_name;\n            customerData.last_name = last_name;\n            customerData.profile_pic = profile_pic;\n        }\n        customerData.phone = phone;\n        customerData.location = location;\n        customerData.addrData = addrData;\n        customerID = await customer_update(customerData);\n        const order = await Order.findOne({ pageId: pageId, userId: userId, status: ORDERSTATUS_PENDING }).exec();\n\n        if (order) {\n            orderData.orderId = order.id;\n\n            let updateOrder = false;\n            if (location) {\n                order.location_lat = location.lat;\n                order.location_long = location.long;\n                order.location_url = location.url;\n                updateOrder = true;\n            }\n\n            if (currentItem) {\n                order.currentItem = currentItem;\n                updateOrder = true;\n            }\n\n            if (qty) {\n                order.qty_total = qty;\n                updateOrder = true;\n\n                // order has total quantity.\n                // items are always 1. this variable will be passed to updateItem\n                orderData.qty = 1;\n            }\n\n            // when I have a split, I am forcing size and qty\n            if (typeof split === 'number') {\n                order.currentItemSplit = split;\n                orderData.sizeId = order.currentItemSize;\n                orderData.qty = 1;\n\n                updateOrder = true;\n            }\n\n            if (originalSplit) {\n                // split increments the items number (+originalSplit)\n                //  and removes 1 (that was the original quantity asked by the user)\n                order.qty_total = order.qty_total + originalSplit - 1;\n                // saving the originalSplit in the order and... \n                order.originalSplit = originalSplit;\n                // ...always saving the split as originalSplit in item.\n                // because the split in the order will be decreased until 1\n                orderData.split = originalSplit;\n                updateOrder = true;\n            }\n\n            // eraseSplit is sent when I am gonna ask the user\n            // about the next pizza.\n            if (eraseSplit) {\n                order.originalSplit = null;\n                order.currentItemSplit = null;\n                updateOrder = true;\n            }\n\n            if (customerID > 0) {\n                order.customerId = customerID;\n                updateOrder = true;\n            }\n\n            if (phone) {\n                order.phone = phone;\n                updateOrder = true;\n            }\n            if (addrData) {\n                order.address = addrData.formattedAddress;\n                updateOrder = true;\n            }\n\n            if (sizeId) {\n                order.currentItemSize = sizeId;\n                updateOrder = true;\n            }\n\n            if (completeItem) {\n                if (order.item_complete) order.item_complete = order.item_complete + 1;\n                else order.item_complete = 1;\n                updateOrder = true;\n            }\n\n            if (confirmOrder) {\n                order.status = ORDERSTATUS_CONFIRMED;\n                updateOrder = true;\n            } else {\n                // when updateorder with flavor, I dont have neither split nor originalSplit\n                // but, if the order has an originalSplit, I am going to send it to the item.\n                // This code should run only if I am not confirming the order.\n                if (order.originalSplit && order.originalSplit > 1) {\n                    orderData.split = order.originalSplit;\n                    updateOrder = true;\n                }\n            }\n\n            if (typeof waitingForAddress === 'boolean') {\n                order.waitingForAddress = waitingForAddress;\n                updateOrder = true;\n            }\n\n            if (waitingFor) {\n                order.waitingFor = waitingFor;\n                updateOrder = true;\n            }\n\n            if (typeof calcTotal === 'boolean') {\n                const total = await getItemsTotal({ orderId: order.id, pageId: order.pageId });\n                if (total > 0 && total !== order.total) {\n                    order.total = total;\n                    updateOrder = true;\n                }\n            }\n\n            if (typeof noBeverage === 'boolean') {\n                order.no_beverage = noBeverage;\n                updateOrder = true;\n            }\n\n            if (updateOrder)\n                await order.save();\n\n            await updateItem(orderData);\n        } else {\n            // const count = await Order.find({ pageId: pageId }).count().exec();\n            // let orderId = 1;\n            // if (count) orderId = count + 1;\n\n            const resultLastId = await Order.find({ pageId: pageId }).select('id').sort('-id').limit(1).exec();\n            let orderId = 1;\n            if (resultLastId && resultLastId.length) orderId = resultLastId[0].id + 1;\n\n            const record = new Order({\n                id: orderId,\n                pageId: pageId,\n                userId: userId,\n                qty_total: qty ? qty : 0,\n                location_lat: location ? location.lat : null,\n                location_long: location ? location.long : null,\n                location_url: location ? location.url : null,\n                waitingForAddress: typeof waitingForAddress === 'boolean' ? waitingForAddress : false,\n                status: ORDERSTATUS_PENDING,\n            });\n            await record.save();\n            orderData.orderId = record.id;\n            await updateItem(orderData);\n        }\n    } catch (updateOrderError) {\n        console.error({ updateOrderError });\n        throw updateOrderError;\n    }\n}\n\nexport const getOrderPending = async orderData => {\n    const { userId, pageId, isComplete } = orderData;\n\n    const _order = await Order.findOne({ userId: userId, pageId: pageId, status: ORDERSTATUS_PENDING }).exec();\n    if (_order) {\n        if (isComplete && isComplete === true) {\n            const _items = await getItems({ orderId: _order.id, pageId: pageId });\n\n            const completeOrder = {\n                order: _order,\n                items: _items,\n            };\n\n            return completeOrder;\n        } else {\n            const headerOrder = {\n                order: _order,\n            }\n            return headerOrder;\n        }\n    } else return null;\n}\n\nexport const getOrdersCustomerStat = async orderData => {\n    const { pageId, customerId } = orderData;\n\n    const orders = await Order.find({ pageId: pageId, customerId: customerId }).select('createdAt total').sort('createdAt').exec();\n    let total_spent = 0;\n    let nb_orders = 0;\n    let first_order = Date.now();\n    let last_order = null;\n    for (const order of orders) {\n        total_spent += order.total;\n        nb_orders += 1;\n\n        if (first_order >= order.createdAt) {\n            first_order = order.createdAt;\n        }\n        if (last_order <= order.createdAt) {\n            last_order = order.createdAt;\n        }\n    }\n    return { total_spent, nb_orders, first_order, last_order };\n}\n\n"],"file":"ordersController.js"}