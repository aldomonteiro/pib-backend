{"version":3,"sources":["../../../src/api/controllers/pagesController.js"],"names":["page_resources_get_all","req","res","sortObj","query","sort","rangeObj","range","options","offset","limit","lean","leanWithId","currentUser","activePage","Page","find","id","paginate","err","result","status","json","message","errmsg","setHeader","util","format","total","docs","Array","page_resources_get_one","params","findOne","doc","errMsg","page_resources_delete","console","info","pageID","getOnePageToken","accessToken","deleteFacebookFields","lastResult","unsubscribedApps","userID","error","findOneAndDelete","exec","page_update","body","operation","page","setFacebookFields","greetingText","subscribedApps","activeBot","save","isNew","name","access_token","firstResponseText","User","user","pageUpdateError","pageId","facebookUrl","axios","post","get","data","length","delete","result1","debugToken","Promise","resolve","marketing","reject","getOnePageData","getAllPages","pageArray","map","log","Object","keys","_greeting","headers","get_started","payload","greeting","locale","text","persistent_menu","composer_input_disabled","call_to_actions","title","type","JSON","stringify","event","url","webview_height_ratio","fields","sendPassThreadControl","recipientId","recipient","target_app_id","metadata","passThreadError"],"mappings":"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","sourcesContent":["\nimport Page from \"../models/pages\";\nimport User from \"../models/users\";\nimport axios from 'axios';\nimport util from 'util';\nimport { configSortQuery, configRangeQuery } from '../util/util';\nimport { initialSetup } from \"./systemController\";\nimport { deleteManyFlavors } from './flavorsController';\nimport { deleteManyBeverages } from './beveragesController';\nimport { deleteManyCustomers } from './customersController';\nimport { deleteManyExtras } from './extrasController';\nimport { deleteManyItems } from './itemsController';\nimport { deleteManyOrders } from './ordersController';\nimport { deleteManyPricings } from './pricingsController';\nimport { deleteManySizes } from './sizesController';\nimport { deleteManyToppings } from './toppingsController';\nimport { deleteManyStores } from './storesController';\nimport { removeUserActivePage } from \"./usersController\";\n\n// List all flavors\n// TODO: use filters in the query req.query\nexport const page_resources_get_all = async (req, res) => {\n    // Getting the sort from the requisition\n    var sortObj = configSortQuery(req.query.sort);\n    // Getting the range from the requisition\n    var rangeObj = configRangeQuery(req.query.range);\n\n    let options = {\n        offset: rangeObj['offset'],\n        limit: rangeObj['limit'],\n        sort: sortObj,\n        lean: true,\n        leanWithId: false,\n    };\n\n    var query = {};\n\n    if (req.currentUser.activePage) {\n        query = Page.find({ id: req.currentUser.activePage });\n        Page.paginate(query, options, async (err, result) => {\n            if (err) {\n                res.status(500).json({ message: err.errmsg });\n            } else {\n                res.setHeader('Content-Range', util.format(\"pages %d-%d/%d\", rangeObj['offset'], rangeObj['limit'], result.total));\n                res.status(200).json(result.docs);\n            }\n        });\n    }\n    else {\n        res.setHeader('Content-Range', util.format(\"pages %d-%d/%d\", 0, 0, 0));\n        res.status(200).json(new Array());\n    }\n};\n\n// List one record by filtering by ID\nexport const page_resources_get_one = (req, res) => {\n    if (req.params && req.params.id) {\n\n        Page.findOne({ id: req.params.id }, (err, doc) => {\n            if (err) {\n                res.status(500).json({ message: err.errMsg });\n            }\n            else {\n                res.status(200).json(doc);\n            }\n        });\n    }\n}\n\n/**\n * Deactivate Bot and delete all related records\n * @param {*} req \n * @param {*} res \n */\nexport const page_resources_delete = async (req, res) => {\n    let lastResult;\n    try {\n        console.info(\"page_resources_delete:\", req.params);\n\n        const pageID = req.params.id;\n        const { accessToken } = await getOnePageToken(pageID);\n\n        lastResult = await deleteFacebookFields(pageID, accessToken);\n\n        lastResult = await deleteManyBeverages(pageID);\n        lastResult = await deleteManyCustomers(pageID);\n        lastResult = await deleteManyExtras(pageID);\n        lastResult = await deleteManyFlavors(pageID);\n        lastResult = await deleteManyItems(pageID);\n        lastResult = await deleteManyOrders(pageID);\n        lastResult = await deleteManyPricings(pageID);\n        lastResult = await deleteManySizes(pageID);\n        lastResult = await deleteManyStores(pageID);\n        lastResult = await deleteManyToppings(pageID);\n\n        lastResult = await unsubscribedApps(pageID, accessToken);\n        lastResult = await removeUserActivePage(req.currentUser.userID);\n        if (!lastResult) {\n            console.error(`User ${userID} was not found and removeUserActivePage failed`);\n        }\n        lastResult = await Page.findOneAndDelete({ id: pageID }).exec();\n        res.status(200).json(lastResult);\n    } catch (pageDeleteErr) {\n        console.info(lastResult);\n        console.error(pageDeleteErr);\n        res.status(500).json({ message: pageDeleteErr.message });\n    }\n}\n\n\n// Update or create a new page\nexport const page_update = async (req, res) => {\n    try {\n        console.info(\"page_update: \", req.body.operation, req.body.id);\n        const pageID = req.body.id;\n        const operation = req.body.operation;\n        let page = await Page.findOne({ id: pageID }).exec();\n\n        if (page && operation === 'ACTIVATE') { // only deactivating the bot in the page\n            await setFacebookFields(pageID, page.accessToken, page.greetingText);\n            await subscribedApps(pageID, page.accessToken);\n            page.activeBot = true;\n            await page.save();\n            res.status(200).json(page);\n        }\n        else if (page && operation === 'DEACTIVATE') { // only deactivating the bot in the page\n            await deleteFacebookFields(pageID, page.accessToken);\n            await unsubscribedApps(pageID, page.accessToken);\n            page.activeBot = false;\n            await page.save();\n            res.status(200).json(page);\n        } else {\n            let isNew = false;\n            if (!page) {\n                page = new Page({\n                    id: pageID,\n                    name: req.body.name,\n                    userID: req.currentUser.userID,\n                    activeBot: false,\n                });\n                isNew = true;\n            }\n            if (req.body.access_token)\n                page.accessToken = req.body.access_token;\n            if (req.body.greetingText)\n                page.greetingText = req.body.greetingText;\n            if (req.body.firstResponseText)\n                page.firstResponseText = req.body.firstResponseText;\n\n            // update ActivePage for the current user\n            if (req.currentUser) {\n                page.userID = req.currentUser.userID;\n                const user = await User.findOne({ userID: req.currentUser.userID }).exec();\n                if (user) {\n                    user.activePage = pageID;\n                    await user.save();\n                }\n            }\n\n            await page.save();\n\n            // if (isNew) {\n            page = await initialSetup(pageID);\n            // }\n            res.status(200).json(page);\n        }\n    } catch (pageUpdateError) {\n        console.error({ pageUpdateError });\n        res.status(500).json({ message: pageUpdateError.message });\n    }\n}\n\n/**\n * Subscribe the app to the page\n * @param {*} pageId \n * @param {*} accessToken \n */\nexport const subscribedApps = async (pageId, accessToken) => {\n\n    // https://graph.facebook.com/v3.1/{page-id}/subscribed_apps?access_token={}\n    const facebookUrl = `https://graph.facebook.com/v3.1/${pageId}/subscribed_apps?access_token=${accessToken}`\n\n    return await axios.post(facebookUrl);\n}\n\n/**\n * \n * @param {*} pageId \n * @param {*} accessToken \n */\nexport const unsubscribedApps = async (pageId, accessToken) => {\n\n    const facebookUrl = `https://graph.facebook.com/v3.1/${pageId}/subscribed_apps?access_token=${accessToken}`\n\n    const result = await axios.get(facebookUrl);\n    if (result.status === 200 && result.data && result.data.data && result.data.data.length > 0) {\n        console.info('unsubscribedApps found app:', result);\n        const result1 = await axios.delete(facebookUrl);\n        console.info('unsubscribedApps deleted app:', result1);\n        return result1;\n    } else {\n        return null;\n    }\n}\n\n\nexport const debugToken = async accessToken => {\n    const facebookUrl = `https://graph.facebook.com/v3.1/debug_token?input_token=${accessToken}`\n    return await axios.get(facebookUrl);\n}\n\n\n// used in botController.js\nexport const getOnePageToken = async (pageID) => {\n    const page = await Page.findOne({ id: pageID }).exec();\n    if (page && page.accessToken)\n        return Promise.resolve({ accessToken: page.accessToken, name: page.name, marketing: page.marketing });\n    else return Promise.reject();\n}\n\n/**\n * \n * @param {*} pageID \n * @return Page\n */\nexport const getOnePageData = async (pageID) => {\n    return await Page.findOne({ id: pageID }).exec();\n}\n\n\nexport const getAllPages = async () => {\n    let pageArray = [];\n    await Page.find({}, (err, result) => {\n        pageArray = result.map(doc => { return { 'pageID': doc.id, 'accessToken': doc.accessToken, 'name': doc.name } });\n    });\n    console.log(\"into getAllPages: \", Object.keys(pageArray).length);\n    return Promise.resolve(pageArray);\n}\n\nconst setFacebookFields = async (pageId, accessToken, _greeting) => {\n    const facebookUrl = `https://graph.facebook.com/v2.6/me/messenger_profile?access_token=${accessToken}`;\n    return await axios.post(facebookUrl, {\n        headers: { 'Content-Type': 'application/json' },\n        get_started: { payload: 'GET_STARTED' },\n        greeting: [\n            { locale: 'default', text: _greeting },\n            { locale: 'pt_BR', text: _greeting },\n            { locale: 'en_US', text: _greeting },\n        ],\n        persistent_menu: [\n            {\n                locale: 'default',\n                composer_input_disabled: false,\n                call_to_actions: [\n                    {\n                        title: 'â“ InformaÃ§Ãµes',\n                        type: 'nested',\n                        call_to_actions: [\n                            {\n                                title: 'ðŸ• CardÃ¡pio',\n                                type: 'postback',\n                                payload: JSON.stringify({ data: 'CARDAPIO_PAYLOAD', event: 'MAIN-MENU' })\n                            },\n                            {\n                                title: 'ðŸ•’ HorÃ¡rios',\n                                type: 'postback',\n                                payload: JSON.stringify({ data: 'HORARIO_PAYLOAD', event: 'MAIN-MENU' })\n                            }],\n                    },\n                    {\n                        title: 'ðŸ“¨ Fazer Pedido',\n                        type: 'postback',\n                        payload: JSON.stringify({ data: 'PEDIDO_PAYLOAD', event: 'MAIN-MENU' })\n                    },\n                    {\n                        type: \"web_url\",\n                        title: \"Powered by Pizzaibot\",\n                        url: \"m.me/pizzaibot\",\n                        webview_height_ratio: \"full\"\n                    }\n\n                ]\n            }\n        ]\n    });\n}\n\nconst deleteFacebookFields = async (pageId, accessToken) => {\n    const facebookUrl = `https://graph.facebook.com/v2.6/me/messenger_profile?access_token=${accessToken}`;\n\n    const result = await axios.get(facebookUrl, {\n        headers: { 'Content-Type': 'application/json' },\n        fields: [\"get_started\", \"persistent_menu\", \"greeting\"]\n    });\n\n    if (result.status === 200 && result.data && result.data.data && result.data.data.length > 0) {\n        console.info('deleteFacebookFields found fields:', result);\n        const result1 = await axios.delete(facebookUrl, {\n            headers: { 'Content-Type': 'application/json' },\n            params: {\n                fields: [\"get_started\", \"persistent_menu\", \"greeting\"]\n            }\n        });\n        console.info('deleteFacebookFields deleted fields:', result1);\n        return result1;\n    } else {\n        console.info('deleteFacebookFields did not found fields:', result);\n        return null;\n    }\n}\n\nexport const sendPassThreadControl = async (pageID, recipientId) => {\n    const page = await getOnePageData(pageID);\n\n    const facebookUrl = `https://graph.facebook.com/v2.6/me/pass_thread_control?access_token=${page.accessToken}`;\n\n    try {\n        const result = await axios.post(facebookUrl, {\n            headers: { 'Content-Type': 'application/json' },\n            recipient: { id: recipientId },\n            target_app_id: \"263902037430900\",\n            metadata: \"pass thread control to inbox\"\n        });\n        return result.status;\n    } catch (passThreadError) {\n        console.error({ passThreadError });\n        return null;\n    }\n}\n\n\n\n// export const page_update = async (req, res) => {\n\n//     console.info(\"page_update\");\n\n//     const pageId = req.body.id;\n\n//     const record = await Page.findOne({ id: pageId }).exec();\n//     if (!record) {\n//         record = new Page({\n//             id: pageId,\n//             name: req.body.name,\n//             accessToken: req.body.access_token,\n//             userID: req.currentUser.userID,\n//         });\n//         isNew = true;\n//     }\n\n//     // Find a page by id\n//     await Page.findOne({ id: pageId }, async (err, doc) => {\n//         if (err) { // err !== null\n//             res.status(500).json({ message: err.errmsg });\n//             return;\n//         }\n//         let record;\n//         let isNew = false;\n\n//         if (doc) {\n//             record = doc;\n//             if (req.body.greetingText)\n//                 record.greetingText = req.body.greetingText;\n//             if (req.body.firstResponseText)\n//                 record.firstResponseText = req.body.firstResponseText;\n//             if (req.body.access_token)\n//                 record.accessToken = req.body.access_token;\n//             record.userID = req.currentUser.userID;\n//         } else {\n//             record = new Page({\n//                 id: pageId,\n//                 name: req.body.name,\n//                 accessToken: req.body.access_token,\n//                 userID: req.currentUser.userID,\n//             });\n//             isNew = true;\n//         }\n\n//         await record.save();\n//         const response = await subscribedApps(record.id, record.accessToken);\n\n//         // await record.save((err, result) => {\n//         //     if (err) {\n//         //         res.status(500).json({ message: err.errmsg });\n//         //     } else {\n//         //         subscribedApps(result.id, result.accessToken)\n//         //             .then(response => {\n//         //                 res.status(200).json(result);\n//         //             }).catch((err) => {\n//         //                 var errorMessage;\n//         //                 if (err.error) errorMessage = err.error;\n//         //                 if (err.response.data)\n//         //                     if (err.response.data.error)\n//         //                         errorMessage = err.response.data.error.message;\n//         //                 console.log(`subscribed_apps catch err: ${errorMessage}`);\n//         //                 res.status(500).json({ message: errorMessage });\n//         //             });\n\n//         //     }\n//     });\n\n//     // update ActivePage for the current user\n//     if (req.currentUser) {\n//         await User.findOne({ userID: req.currentUser.userID }, (err, docFind) => {\n//             if (err) {\n//                 res.status(500).json({ message: err.errmsg });\n//                 return;\n//             }\n\n//             if (docFind) {\n//                 docFind.activePage = pageId;\n//                 docFind.save((err, docSave) => {\n//                     if (err) {\n//                         res.status(500).json({ message: err.errmsg });\n//                     }\n//                 })\n//             }\n//         });\n//     }\n\n//     if (isNew) {\n//         record = await initialSetup(pageId);\n//         req.body.greetingText = record.greetingText\n//     }\n\n//     if (req.body.greetingText && record && record.accessToken) {\n//         setFacebookFields(record.id, record.accessToken, req.body.greetingText).then(response => {\n//             console.log('PagesController, response from set fields:', response.result);\n//         }).catch(err => {\n//             if (err.response && err.response.data && err.response.data.error)\n//                 console.log(`PagesController, error from set fields: ${err.response.data.error.message}`);\n//             else if (err.response)\n//                 console.log(err.response);\n//         });\n//     }\n\n//     const responseDebug = await debugToken(record.accessToken);\n//     console.info('debugToken', responseDebug);\n// });\n// }\n\n\n\n"],"file":"pagesController.js"}