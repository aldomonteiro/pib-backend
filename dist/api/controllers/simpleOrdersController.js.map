{"version":3,"sources":["../../../src/api/controllers/simpleOrdersController.js"],"names":["ORDERSTATUS_PENDING","ORDERSTATUS_CONFIRMED","ORDERSTATUS_VIEWED","ORDERSTATUS_ACCEPTED","ORDERSTATUS_PRINTED","ORDERSTATUS_DELIVERED","ORDERSTATUS_FINISHED","ORDERSTATUS_REJECTED","ORDERSTATUS_CANCELLED","order_get_all","req","res","sortObj","query","sort","rangeObj","range","filterObj","filter","queryParam","currentUser","activePage","filterField","length","i","value","filterValues","Array","isArray","dateIni","DateTime","fromISO","set","hour","minute","second","setZone","dateEnd","invalid","$gte","toISO","$lt","$in","date","endsWith","replace","rezonedIni","rezonedEnd","plus","days","Object","values","fullOrderGetAll","ret","setHeader","util","format","rangeIni","rangeEnd","totalCount","status","json","ordersArray","console","error","orderGetAllErr","message","order_get_one","params","id","pageId","getOrderJson","jsonOrder","orderGetOneError","appendTimedComments","comments","dateTime","local","hours","order_update","body","dir","operation","Order","findOne","doc","updateOrder","rejectionExplanation","sent_reject_notification","rejection_reason","userId","store","notif","accept_notification","sendNotification","phone","deliver_notification","missing_address_notification","question","newAddress","newDetails","newTotal","totalNotification","updatePostComments","updatedPostComment","closeOrder","address","details","formatted","toString","isNaN","Number","total","total_notification","index","postComments","indexOf","splice","status2","delivered_at","source","sent_shipping_notification","info","save","deleteManyOrders","pageID","deleteMany","exec","orderId","order","customerId","customer","getOrderData","getOrderJsonErr","Error","cleaned","match","customerName","first_name","last_name","profile_pic","createdAt","updatedAt","confirmed_at","changed_at","orderData","user","addrData","confirmOrder","waitingFor","mergeComments","customerData","getLastUserOrder","formattedAddress","location_lat","location_long","push","orderJson","find","select","limit","resultLastId","_comments","updateOrderError","queryObj","result","offset","savedCustomers","getOrderPending","_order","headerOrder","resultLast","getLastOrder","getLastPendingOrders","orders","getOrdersCustomerStat","total_spent","nb_orders","first_order","Date","now","last_order","whatsAppId"],"mappings":"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","sourcesContent":["import Order from '../models/orders';\nimport util from 'util';\nimport { updateCustomer, getCustomerById } from './customersController';\nimport { getStoreData } from './storesController';\nimport {\n    configSortQuery, configRangeQueryNew,\n    configFilterQueryMultiple,\n    formatAsCurrency,\n} from '../util/util';\nimport { DateTime } from 'luxon';\n// import { Bot, Elements } from 'facebook-messenger-bot';\n// import { getOnePageToken } from './pagesController';\nimport { sendShippingNotification, sendRejectionNotification } from '../bot/botController';\nimport { emitEvent } from './redisController';\nimport { emitEventWhats } from './socketController';\nexport const ORDERSTATUS_PENDING = 0;\nexport const ORDERSTATUS_CONFIRMED = 1;\nexport const ORDERSTATUS_VIEWED = 2;\nexport const ORDERSTATUS_ACCEPTED = 3;\nexport const ORDERSTATUS_PRINTED = 4;\nexport const ORDERSTATUS_DELIVERED = 5;\nexport const ORDERSTATUS_FINISHED = 7;\nexport const ORDERSTATUS_REJECTED = 8;\nexport const ORDERSTATUS_CANCELLED = 9;\n\n// List all orders\n// TODO: use filters in the query req.query\nexport const order_get_all = async (req, res) => {\n    try {\n        const sortObj = configSortQuery(req.query.sort);\n        const rangeObj = configRangeQueryNew(req.query.range);\n        const filterObj = configFilterQueryMultiple(req.query.filter);\n\n        let queryParam = {};\n        if (req.currentUser.activePage) {\n            queryParam['pageId'] = req.currentUser.activePage;\n        }\n\n        // queryParam['status'] = { $gte: ORDERSTATUS_CONFIRMED };\n\n        if (!sortObj) {\n            sortObj['status'] = 'ASC';\n        }\n\n        if (filterObj && filterObj.filterField && filterObj.filterField.length) {\n            for (let i = 0; i < filterObj.filterField.length; i++) {\n                let filter = filterObj.filterField[i];\n                const value = filterObj.filterValues[i];\n                if (Array.isArray(value)) {\n                    if (value.length === 2) {\n                        const dateIni = DateTime.fromISO(value[0]).set({ hour: 0, minute: 0, second: 0 }).setZone('UTC');\n                        const dateEnd = DateTime.fromISO(value[1]).set({ hour: 23, minute: 59, second: 59 }).setZone('UTC');\n\n                        if (!dateIni.invalid && !dateEnd.invalid)// is date\n                            queryParam[filter] = { $gte: dateIni.toISO(), $lt: dateEnd.toISO() };\n                        else\n                            queryParam[filter] = { $in: value };\n                    } else\n                        queryParam[filter] = { $in: value };\n                } else {\n                    const date = DateTime.fromISO(value);\n                    if (!date.invalid) { // is a date\n                        // date comes with the current time, so, I am setting it to midnight.\n                        // Mongoose stores data on GMT timezone\n                        if (filter.endsWith('_rangestart')) {\n                            filter = filter.replace('_rangestart', '');\n                            const rezonedIni = date.set({ hour: 0, minute: 0, second: 0 }).setZone('UTC');\n                            queryParam[filter] = { $gte: rezonedIni.toISO() };\n                        } else if (filter.endsWith('_rangeend')) {\n                            filter = filter.replace('_rangeend', '');\n                            const rezonedIni = date.set({ hour: 0, minute: 0, second: 0 }).setZone('UTC');\n                            const rezonedEnd = rezonedIni.plus({ days: 1 });\n                            if (queryParam[filter])\n                                queryParam[filter] = { $gte: Object.values(queryParam[filter])[0], $lt: rezonedEnd.toISO() };\n                            else\n                                queryParam[filter] = { $lt: rezonedEnd.toISO() };\n                        } else {\n                            const rezonedIni = date.set({ hour: 0, minute: 0, second: 0 }).setZone('UTC');\n                            const rezonedEnd = rezonedIni.plus({ days: 1 });\n                            queryParam[filter] = { $gte: rezonedIni.toISO(), $lt: rezonedEnd.toISO() };\n                        }\n                    } else\n                        queryParam[filter] = value;\n                }\n            }\n        }\n\n        const ret = await fullOrderGetAll(queryParam, sortObj, rangeObj);\n        res.setHeader('Content-Range',\n            util.format('orders %d-%d/%d',\n                ret.rangeIni, ret.rangeEnd, ret.totalCount));\n        res.status(200).json(ret.ordersArray);\n\n    } catch (orderGetAllErr) {\n        console.error({ orderGetAllErr })\n        res.status(500).json({ message: orderGetAllErr.message });\n    }\n};\n\n// List one record by filtering by ID\nexport const order_get_one = async (req, res) => {\n    if (req.params && req.params.id) {\n        try {\n            const pageId = req.currentUser.activePage ? req.currentUser.activePage : null;\n            const jsonOrder = await getOrderJson(pageId, req.params.id);\n            res.status(200).json(jsonOrder);\n        } catch (orderGetOneError) {\n            console.error({ orderGetOneError });\n            res.status(500).json({ message: orderGetOneError.message });\n        }\n    }\n}\n\nconst appendTimedComments = comments => {\n    const dateTime = DateTime.local().setZone('America/Sao_Paulo');\n    const hours = dateTime.hour + ':' + dateTime.minute + '> ';\n    return hours + comments;\n}\n\n// UPDATE\nexport const order_update = async (req, res) => {\n    if (req.body && req.body.id) {\n        try {\n            console.dir(req.body);\n            const { id, operation } = req.body;\n            const pageId = req.currentUser.activePage;\n            const doc = await Order.findOne({ pageId: pageId, id: id });\n\n            let updateOrder = true;\n\n            if (operation === 'REJECT') {\n                const { rejectionExplanation } = req.body;\n\n                doc.status = ORDERSTATUS_REJECTED;\n                doc.sent_reject_notification = DateTime.local();\n                doc.rejection_reason = rejectionExplanation;\n                sendRejectionNotification(doc.pageId, doc.userId, doc.id, rejectionExplanation);\n            } else if (operation === 'VIEW') {\n                doc.status = ORDERSTATUS_VIEWED;\n                // sendRejectionNotification(doc.pageId, doc.userId, doc.id, rejectionExplanation);\n            } else if (operation === 'ACCEPT') {\n                doc.status = ORDERSTATUS_ACCEPTED;\n                const store = await getStoreData(doc.pageId);\n                const notif = store.accept_notification;\n                if (notif) {\n                    doc.comments = doc.comments + '\\n' + appendTimedComments(notif)\n                    sendNotification(store.phone, doc.userId, notif);\n                }\n            } else if (operation === 'PRINT') {\n                doc.status = ORDERSTATUS_PRINTED;\n                // sendRejectionNotification(doc.pageId, doc.userId, doc.id, rejectionExplanation);\n            } else if (operation === 'DELIVER') {\n                doc.status = ORDERSTATUS_DELIVERED;\n                const store = await getStoreData(doc.pageId);\n\n                const notif = store.deliver_notification;\n                if (notif) {\n                    doc.comments = doc.comments + '\\n' + appendTimedComments(notif)\n                    sendNotification(store.phone, doc.userId, notif);\n                }\n            } else if (operation === 'MISSING_ADDRESS') {\n                updateOrder = false;\n                const store = await getStoreData(doc.pageId);\n\n                const notif = store.missing_address_notification;\n                if (notif) {\n                    updateOrder = true;\n                    doc.comments = doc.comments + '\\n' + appendTimedComments(notif)\n                    sendNotification(store.phone, doc.userId, notif);\n                }\n            } else if (operation === 'OPEN_QUESTION') {\n                const { question } = req.body;\n                // doc.comments = doc.comments + '\\n' + question;\n                const store = await getStoreData(doc.pageId);\n\n                const notif = question;\n                if (notif) {\n                    updateOrder = true;\n                    doc.comments = doc.comments + '\\n' + appendTimedComments(notif)\n                    sendNotification(store.phone, doc.userId, notif);\n                }\n            } else if (operation === 'UPDATE_ORDER_DATA') {\n                const {\n                    newAddress,\n                    newDetails,\n                    newTotal, totalNotification,\n                    updatePostComments, updatedPostComment,\n                    closeOrder } = req.body;\n                if (newAddress)\n                    doc.address = newAddress;\n                else if (newDetails)\n                    doc.details = newDetails;\n                else if (newTotal) {\n                    const formatted = newTotal.toString().replace(',', '.')\n                    if (!isNaN(Number(formatted))) {\n                        doc.total = Number(formatted);\n\n                        if (totalNotification) {\n                            const store = await getStoreData(doc.pageId);\n\n                            const notif = store.total_notification;\n                            if (notif) {\n                                const message = notif.toString().replace('$TOTAL', formatAsCurrency(doc.total))\n                                updateOrder = true;\n                                doc.comments = doc.comments + '\\n' + appendTimedComments(message)\n                                sendNotification(store.phone, doc.userId, message);\n                            }\n                        }\n                    } else {\n                        res.status(500).json({ message: 'pos.orders.messages.invalidTotal' });\n                        return\n                    }\n                } else if (updatePostComments) {\n                    if (updatePostComments === 'MERGE') {\n                        doc.details = doc.details ? doc.details + '\\n' + updatedPostComment : updatedPostComment;\n                        const index = doc.postComments.indexOf(updatedPostComment);\n                        doc.postComments.splice(index, 1);\n                    } else if (updatePostComments === 'DELETE') {\n                        const index = doc.postComments.indexOf(updatedPostComment);\n                        doc.postComments.splice(index, 1);\n                    }\n                } else if (closeOrder) {\n                    doc.status = ORDERSTATUS_FINISHED;\n                }\n            } else {\n                if (req.body.status2 === 'ordered') {\n                    doc.status = ORDERSTATUS_CONFIRMED;\n                } else if (req.body.status2 === 'delivered') {\n                    doc.status = ORDERSTATUS_DELIVERED;\n                    doc.delivered_at = DateTime.local();\n                } else if (req.body.status2 === 'cancelled') {\n                    doc.status = ORDERSTATUS_DELIVERED;\n                }\n                if (doc.status === ORDERSTATUS_DELIVERED) {\n                    if (doc.source !== 'whatsapp') {\n                        if (!doc.sent_shipping_notification) {\n                            console.info('I am going to send to ' + doc.userId + ', about the order number:' + doc.id + ' a shipping notification');\n                            await sendShippingNotification(doc.pageId, doc.userId, doc.id);\n                            doc.sent_shipping_notification = DateTime.local();\n                        }\n                    }\n                }\n            }\n            if (updateOrder)\n                await doc.save();\n            const jsonOrder = await getOrderJson(pageId, doc.id);\n            res.status(200).json(jsonOrder);\n        } catch (orderUpdateErr) {\n            console.error(orderUpdateErr);\n            res.status(500).json({ message: orderUpdateErr.message });\n        }\n    }\n}\n\n/**\n * Delete all records from a pageID\n * @param {*} pageID\n */\nexport const deleteManyOrders = async (pageID) => {\n    return await Order.deleteMany({ pageId: pageID }).exec();\n}\n\n// List one record by filtering by ID\nexport const getOrderJson = async (pageId, orderId) => {\n    try {\n        const order = await Order.findOne({ pageId: pageId, id: orderId });\n        if (order) {\n            const customer = await getCustomerById(pageId, order.customerId);\n            return getOrderData(order, customer);\n        } else return null;\n    } catch (getOrderJsonErr) {\n        console.error({ getOrderJsonErr });\n        throw new Error(getOrderJsonErr.message);\n    }\n}\n\nconst getOrderData = (order, customer) => {\n    let cleaned = ('' + order.phone).replace(/\\D/g, '')\n    const match = cleaned.match(/^(\\d{2})(\\d{2})(\\d{4})(\\d{4})$/)\n    if (match) {\n        cleaned = `+${match[1]} (${match[2]}) ${match[3]}-${match[4]}`\n    }\n    const jsonOrder = {\n        id: order.id,\n        customerId: order.customerId,\n        customerName: customer ? customer.first_name + ' ' + (customer.last_name || '') : null,\n        profile_pic: customer ? customer.profile_pic : null,\n        createdAt: order.createdAt,\n        updatedAt: order.updatedAt,\n        confirmed_at: order.confirmed_at,\n        changed_at: order.changed_at,\n        status: order.status,\n        status2: order.status2,\n        phone: cleaned,\n        address: order.address,\n        total: order.total,\n        details: order.details,\n        comments: order.comments,\n        postComments: order.postComments,\n    }\n    return jsonOrder;\n}\n\nexport const updateOrder = async orderData => {\n    try {\n        const { pageId, userId, user,\n            phone, addrData, confirmOrder,\n            waitingFor,\n            comments, postComments, mergeComments,\n        } = orderData;\n\n        let customerData = {}\n        customerData.pageId = pageId;\n        customerData.userId = userId;\n        if (user) {\n            const { first_name, last_name, profile_pic } = user;\n            customerData.first_name = first_name;\n            customerData.last_name = last_name;\n            customerData.profile_pic = profile_pic;\n        }\n        customerData.phone = phone;\n        customerData.addrData = addrData;\n        const customer = await updateCustomer(customerData);\n        // const order = await Order.findOne({ pageId: pageId, userId: userId, status: { $lt: ORDERSTATUS_FINISHED } }).exec();\n        const order = await getLastUserOrder({\n            pageId: pageId, userId: userId,\n            status: ORDERSTATUS_FINISHED,\n        });\n\n        if (order) {\n            orderData.orderId = order.id;\n\n            let updateOrder = false;\n\n            if (addrData) {\n                order.address = addrData.formattedAddress;\n                if (addrData.location_lat && addrData.location_long) {\n                    order.location_lat = addrData.location_lat;\n                    order.location_long = addrData.location_long;\n                }\n                updateOrder = true;\n            }\n\n            if (customer > 0) {\n                order.customerId = customer.id;\n                updateOrder = true;\n            }\n\n            if (phone) {\n                order.phone = phone;\n                updateOrder = true;\n            }\n\n            if (confirmOrder) {\n                if (order.status < ORDERSTATUS_CONFIRMED) {\n                    order.status = ORDERSTATUS_CONFIRMED;\n                    order.confirmed_at = DateTime.local();\n                    updateOrder = true;\n                }\n            }\n\n            if (waitingFor) {\n                order.waitingFor = waitingFor;\n                updateOrder = true;\n            }\n\n            if (comments) {\n                order.comments = comments;\n                updateOrder = true;\n            }\n\n            if (postComments) {\n                if (!order.postComments)\n                    order.postComments = [];\n\n                // let arrPostComments = postComments.split('\\n');\n                // order.postComments = order.postComments.concat(arrPostComments);\n\n                order.postComments.push(postComments);\n\n                const dateTime = DateTime.local().setZone('America/Sao_Paulo');\n                const hours = dateTime.hour + ':' + dateTime.minute + '> ';\n\n                if (mergeComments)\n                    order.comments = order.comments ? order.comments + '\\n' + hours + postComments : hours + postComments;\n\n                updateOrder = true;\n            }\n\n            if (updateOrder) {\n                // changed_at keeps the last time the user sent a message.\n                order.changed_at = DateTime.local();\n                await order.save();\n            }\n\n            if (confirmOrder || comments || postComments) {\n                // every time new comments are stored I am passing the confirmOrder parameter. So,\n                // here I check if this order was not already confirmed.\n                // if (confirmOrder && currentStatus < ORDERSTATUS_CONFIRMED) {\n                //     // emitEvent(pageId, 'new-order', order);\n                // } else \n                if (comments || postComments) {\n                    const orderJson = getOrderData(order, customer);\n                    emitEvent(pageId, 'new-comment', orderJson);\n                }\n            }\n\n        } else {\n            // const count = await Order.find({ pageId: pageId }).count().exec();\n            // let orderId = 1;\n            // if (count) orderId = count + 1;\n\n            const resultLastId = await Order.find({ pageId: pageId }).select('id').sort('-id').limit(1).exec();\n            let orderId = 1;\n            if (resultLastId && resultLastId.length) orderId = resultLastId[0].id + 1;\n\n            const dateTime = DateTime.local().setZone('America/Sao_Paulo');\n            const hours = dateTime.hour + ':' + dateTime.minute + '> ';\n\n            let _comments;\n            if (mergeComments && postComments)\n                _comments = comments ? comments + '\\n' + hours + postComments : hours + postComments;\n            else\n                _comments = hours + comments;\n\n            // First message goes to details, not to postComments\n            const order = new Order({\n                id: orderId,\n                pageId: pageId,\n                userId: userId,\n                customerId: customer.id,\n                phone: phone,\n                waitingFor: waitingFor,\n                comments: _comments,\n                details: postComments,\n                status: ORDERSTATUS_PENDING,\n            });\n            await order.save();\n\n            const orderJson = getOrderData(order, customer)\n\n            emitEvent(pageId, 'new-order', orderJson);\n        }\n    } catch (updateOrderError) {\n        console.error({ updateOrderError });\n        throw updateOrderError;\n    }\n}\n\nconst fullOrderGetAll = async (queryObj, sortObj, rangeObj) => {\n    const ret = {\n        rangeIni: 0,\n        rangeEnd: 0,\n        totalCount: 0,\n        ordersArray: [],\n    }\n\n    try {\n        const result = await Order.find(queryObj).sort(sortObj).exec();\n\n        ret.rangeIni = 0;\n        ret.rangeEnd = result ? result.length : 0;\n        ret.totalCount = result ? result.length : 0;\n\n        if (rangeObj) {\n            ret.rangeIni = rangeObj.offset <= result.length ? rangeObj.offset : result.length;\n            ret.rangeEnd = (rangeObj.offset + rangeObj.limit) <= result.length ? rangeObj.offset + rangeObj.limit : result.length;\n        }\n\n        ret.ordersArray = [];\n        if (result && result.length && result.length > 0) {\n\n            // workaround to show totalamount and totalitems in the frontend, because\n            // I am only sending part of the list (pagination)\n            // let asideTotalAmount = 0;\n            // let asideTotalItems = result.length;\n            // for (const order of result) {\n            //     asideTotalAmount = asideTotalAmount + order.total;\n            // }\n            // workaround end: all orders will receive these values.\n\n            // instant cache to not query the database anytime.\n            const savedCustomers = {};\n            for (let i = ret.rangeIni; i < ret.rangeEnd; i++) {\n                const order = result[i];\n                if (!savedCustomers[order.customerId]) {\n                    const customer = await getCustomerById(order.pageId, order.customerId);\n                    savedCustomers[order.customerId] = customer;\n                }\n\n                const jsonOrder = getOrderData(order, savedCustomers[order.customerId]);\n                ret.ordersArray.push(jsonOrder);\n            }\n        }\n        return ret;\n    } catch (error) {\n        console.error(error);\n        return ret;\n    }\n}\n\n\nexport const getOrderPending = async orderData => {\n    const { userId, pageId } = orderData;\n\n    const _order = await Order.findOne({\n        userId: userId, pageId: pageId,\n        status: { $lt: ORDERSTATUS_FINISHED },\n    }).exec();\n    if (_order) {\n        const headerOrder = {\n            order: _order,\n        }\n        return headerOrder;\n    }\n    else return null;\n}\n\nexport const getLastUserOrder = async orderData => {\n    const { userId, pageId, status } = orderData;\n\n    const resultLast = await Order.find({\n        pageId: pageId,\n        userId: userId,\n        status: { $lt: status },\n    }).sort('-id').limit(1).exec();\n    if (resultLast && resultLast.length)\n        return resultLast[0];\n    else return null;\n}\n\nexport const getLastOrder = async pageID => {\n    const resultLastId = await Order.find({ pageId: pageID, status: { $gte: ORDERSTATUS_CONFIRMED } }).select('id').sort('-confirmed_at').limit(1).exec();\n    if (resultLastId && resultLastId.length)\n        return resultLastId[0].id;\n    else return 0;\n}\n\nexport const getLastPendingOrders = async pageID => {\n    const orders = await Order.find({ pageId: pageID, status: ORDERSTATUS_CONFIRMED })\n        .select('id confirmed_at')\n        .sort('-confirmed_at')\n        .exec();\n\n    if (orders && orders.length)\n        return orders;\n    else return [];\n}\n\n\nexport const getOrdersCustomerStat = async orderData => {\n    const { pageId, customerId } = orderData;\n\n    const orders = await Order.find({ pageId: pageId, customerId: customerId }).select('createdAt total').sort('createdAt').exec();\n    let total_spent = 0;\n    let nb_orders = 0;\n    let first_order = Date.now();\n    let last_order = null;\n    for (const order of orders) {\n        total_spent += order.total;\n        nb_orders += 1;\n\n        if (first_order >= order.createdAt) {\n            first_order = order.createdAt;\n        }\n        if (last_order <= order.createdAt) {\n            last_order = order.createdAt;\n        }\n    }\n    return { total_spent, nb_orders, first_order, last_order };\n}\n\nconst sendNotification = (whatsAppId, userId, message) => {\n    emitEventWhats(whatsAppId, 'notify', { userId: userId, message: message })\n}"],"file":"simpleOrdersController.js"}