{"version":3,"sources":["../../../src/api/controllers/usersController.js"],"names":["users_auth","req","res","body","User","findOne","userID","exec","user","name","email","pictureUrl","accessToken","timeZone","locationName","lastLogin","Date","now","shortLivedToken","changeAccessToken","respChangeToken","hasOwnProperty","data","access_token","hasLongLivedToken","longLivedToken","save","status","json","toAuthJSON","console","error","users_auth_error","message","users_create","queryUser","foundUser","log","newRecord","then","record","catch","err","users_get_all","rangeObj","query","range","find","result","errmsg","setHeader","util","format","total","users_get_one","params","id","doc","errMsg","users_update","updatedElement","sanitizeName","findOneAndUpdate","oldResult","newResult","_id","success","msg","users_delete","findOneAndRemove","dotenv","config","env","process","NODE_ENV","facebook_secret_key","facebook_app_id","FACEBOOK_APP_ID","FACEBOOK_SECRET_KEY","DEV_FACEBOOK_APP_ID","DEV_FACEBOOK_SECRET_KEY","facebookAccessTokenUrl","FACEBOOK_URL_OAUTH_ACCESS_TOKEN","grant_type","client_id","client_secret","fb_exchange_token","axios","get"],"mappings":"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","sourcesContent":["import User from \"../models/users\";\nimport axios from 'axios';\nimport dotenv from \"dotenv\";\nimport util from \"util\";\nimport { configSortQuery, configRangeQuery } from '../util/util';\n\nexport const users_auth = async (req, res) => {\n    if (req.body) {\n        try {\n            let user = await User.findOne({ userID: req.body.userID }).exec();\n            if (!user) {\n                user = new User({\n                    userID: req.body.userID,\n                    name: req.body.name,\n                    email: req.body.email,\n                    pictureUrl: req.body.pictureUrl,\n                    accessToken: req.body.accessToken,\n                    timeZone: req.body.timeZone,\n                    locationName: req.body.locationName,\n                });\n            } else {\n                user.accessToken = req.body.accessToken;\n            }\n\n            user.lastLogin = Date.now();\n            user.locationName = req.body.locationName;\n            user.shortLivedToken = user.accessToken; // only for debug analysis\n\n            const respChangeToken = await changeAccessToken(user.accessToken);\n            if (respChangeToken) {\n                if (respChangeToken.hasOwnProperty('data')) {\n                    if (respChangeToken.data.hasOwnProperty('access_token')) {\n                        respChangeToken.access_token = respChangeToken.data.access_token;\n                    }\n                }\n                user.hasLongLivedToken = true;\n                user.longLivedToken = respChangeToken.access_token; // only for debug analysis\n                user.accessToken = respChangeToken.access_token; // the token used in the system\n            }\n\n            await user.save();\n            res.status(200).json({ user: user.toAuthJSON() });\n        } catch (users_auth_error) {\n            console.error({ users_auth_error });\n            res.status(500).json({ message: users_auth_error.message });\n        }\n    }\n}\n\nexport const users_create = (req, res) => {\n    var queryUser = User.findOne({ userID: req.body.userID });\n    const foundUser = queryUser.exec();\n    console.log(\"users_create\");\n    console.log(foundUser);\n    if (foundUser) {\n        users_auth(req, res);\n    } else {\n        const newRecord = new User({\n            userID: req.body.userID,\n            name: req.body.name,\n            email: req.body.email,\n            pictureUrl: req.body.pictureUrl,\n            accessToken: req.body.accessToken,\n            timeZone: req.body.timeZone,\n        });\n\n        changeAccessToken(newRecord.accessToken)\n            .then((data) => {\n                newRecord.hasLongLivedToken = true;\n                newRecord.accessToken = data.access_token;\n                newRecord.save()\n                    .then(record => res.status(200).json({ user: record.toAuthJSON() }))\n                    .catch((err) => {\n                        console.error(err);\n                        res.status(500).json(err)\n                    });\n            })\n            .catch((err) => {\n                console.error(err);\n                res.status(500).json(err)\n            });\n    }\n}\n\n// List all users\n// TODO: use filters in the query req.query\nexport const users_get_all = (req, res) => {\n    // Getting the sort from the requisition\n    // var sortObj = configSortQuery(req.query.sort);\n    // Getting the range from the requisition\n    var rangeObj = configRangeQuery(req.query.range);\n\n    // let options = {\n    //     offset: rangeObj['offset'],\n    //     limit: rangeObj['limit'],\n    //     sort: sortObj,\n    //     lean: true,\n    //     leanWithId: false,\n    // };\n\n    var query = {};\n\n    // User.paginate(query, options, (err, result) => {\n    User.find((err, result) => {\n        if (err) {\n            res.status(500).json({ message: err.errmsg });\n        } else {\n            res.setHeader('Content-Range', util.format(\"users %d-%d/%d\", rangeObj['offset'], rangeObj['limit'], result.total));\n            res.status(200).json(result);\n        }\n    });\n}\n\n// List one record by filtering by ID\nexport const users_get_one = (req, res) => {\n    if (req.params && req.params.id) {\n\n        User.findOne({ userID: req.params.id }, (err, doc) => {\n            if (err) {\n                res.status(500).json({ message: err.errMsg });\n            }\n            else {\n                res.status(200).json(doc);\n            }\n        });\n    }\n}\n\n// UPDATE\nexport const users_update = (req, res) => {\n    let updatedElement = {\n        id: req.body.id,\n        name: sanitizeName(req.body.name),\n        email: req.body.email,\n    };\n\n    User.findOneAndUpdate({ id: req.params.id }, updatedElement)\n        .then((oldResult) => {\n            User.findOne({ id: req.params.id })\n                .then((newResult) => {\n                    res.json({\n                        data: {\n                            _id: newResult._id,\n                            id: newResult.id,\n                            name: newResult.name,\n                            email: newResult.email,\n                        }\n                    });\n                })\n                .catch((err) => {\n                    console.log(err);\n                    res.status(500).json({ success: false, msg: `Something went wrong. ${err}` });\n                    return;\n                });\n        })\n        .catch((err) => {\n            if (err) {\n                console.log(err);\n                res.status(500).json({ success: false, msg: `Something went wrong. ${err}` });\n            }\n        });\n}\n\n// DELETE\nexport const users_delete = (req, res) => {\n    User.findOneAndRemove({ id: req.params.id })\n        .then((result) => {\n            res.json({\n                success: true,\n                msg: `It has been deleted.`,\n            });\n        })\n        .catch((err) => {\n            res.status(404).json({ success: false, msg: 'Nothing to delete.' });\n        });\n}\n\n\n\nexport const changeAccessToken = async (accessToken) => {\n    try {\n        dotenv.config();\n\n        const env = process.env.NODE_ENV || 'production';\n        let facebook_app_id, facebook_secret_key = '';\n\n        if (env === 'production') {\n            facebook_app_id = process.env.FACEBOOK_APP_ID;\n            facebook_secret_key = process.env.FACEBOOK_SECRET_KEY;\n        } else {\n            facebook_app_id = process.env.DEV_FACEBOOK_APP_ID;\n            facebook_secret_key = process.env.DEV_FACEBOOK_SECRET_KEY;\n        }\n\n        const facebookAccessTokenUrl = process.env.FACEBOOK_URL_OAUTH_ACCESS_TOKEN;\n        const params = {\n            grant_type: 'fb_exchange_token',\n            client_id: facebook_app_id,\n            client_secret: facebook_secret_key,\n            fb_exchange_token: accessToken,\n        }\n        return await axios.get(facebookAccessTokenUrl, { params });\n    } catch (changeAccessTokenError) {\n        console.error({ changeAccessToken });\n        return null;\n    }\n    // return await axios.get(facebookAccessTokenUrl, { params }).then(res => res.data);\n}\n\n"],"file":"usersController.js"}