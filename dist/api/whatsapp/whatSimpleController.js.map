{"version":3,"sources":["../../../src/api/whatsapp/whatSimpleController.js"],"names":["w_controller","args","console","log","dir","myId","message","userId","contactName","profileImg","quotedMsg","processedMsg","names","split","first_name","shift","last_name","length","join","_profile_pic","decodeURIComponent","replace","user","profile_pic","store","info","name","pageId","sendActions","action","pageID","userID","text","result","multiple","data","payload","location","out","error","waboxapp_sendMessage","to","myToken","uid","custom_uid","encodeURIComponent","Math","random","qText","waboxApp","axios","get"],"mappings":";;;;;;;AAAA;;AACA;;AACA;;AAMA;;AACA;;AAOA;;;;;;;;AAEA;;;;;AAKO,IAAMA,YAAY;AAAA;AAAA;AAAA;AAAA;AAAA,0BAAG,iBAAOC,IAAP;AAAA;;AAAA;AAAA;AAAA;AAAA;AACxBC,YAAAA,OAAO,CAACC,GAAR,CAAY,mCAAZ;AACAD,YAAAA,OAAO,CAACE,GAAR,CAAYH,IAAZ;AACQI,YAAAA,IAHgB,GAG8CJ,IAH9C,CAGhBI,IAHgB,EAGVC,OAHU,GAG8CL,IAH9C,CAGVK,OAHU,EAGDC,MAHC,GAG8CN,IAH9C,CAGDM,MAHC,EAGOC,WAHP,GAG8CP,IAH9C,CAGOO,WAHP,EAGoBC,UAHpB,GAG8CR,IAH9C,CAGoBQ,UAHpB,EAGgCC,SAHhC,GAG8CT,IAH9C,CAGgCS,SAHhC,EAIxB;AACA;;AACMC,YAAAA,YANkB,GAMHD,SAAS,GAAGA,SAAS,GAAG,IAAZ,GAAmBJ,OAAtB,GAAgCA,OANtC;AAQlBM,YAAAA,KARkB,GAQVJ,WAAW,CAACK,KAAZ,CAAkB,GAAlB,CARU;AASlBC,YAAAA,UATkB,GASLF,KAAK,CAACG,KAAN,EATK;AAUlBC,YAAAA,SAVkB,GAUNJ,KAAK,CAACK,MAAN,IAAgB,CAAhB,GAAoBL,KAAK,CAACM,IAAN,CAAW,GAAX,CAApB,GAAsC,IAVhC;AAWlBC,YAAAA,YAXkB,GAWHV,UAAU,IAAIW,kBAAkB,CAACX,UAAU,CAACY,OAAX,CAAmB,gCAAnB,EAAqD,EAArD,CAAD,CAX7B;AAYlBC,YAAAA,IAZkB,GAYX;AACTR,cAAAA,UAAU,EAAEA,UADH;AAETE,cAAAA,SAAS,EAAEA,SAFF;AAGTO,cAAAA,WAAW,EAAEJ;AAHJ,aAZW;AAAA;AAAA,mBAmBJ,uCAAgBd,IAAhB,CAnBI;;AAAA;AAmBlBmB,YAAAA,KAnBkB;;AAAA,iBAoBpBA,KApBoB;AAAA;AAAA;AAAA;;AAqBpBtB,YAAAA,OAAO,CAACuB,IAAR,uBAA4BD,KAAK,CAACE,IAAlC;AACQC,YAAAA,MAtBY,GAsBDH,KAtBC,CAsBZG,MAtBY;AAAA;AAAA,mBAwBCC,WAAW,CAAC;AAC7BC,cAAAA,MAAM,EAAE,2BADqB;AAE7BC,cAAAA,MAAM,EAAEH,MAFqB;AAG7BI,cAAAA,MAAM,EAAExB,MAHqB;AAI7ByB,cAAAA,IAAI,EAAErB,YAJuB;AAK7BW,cAAAA,IAAI,EAAEA;AALuB,aAAD,CAxBZ;;AAAA;AAwBdW,YAAAA,MAxBc;AAAA,6CA+BbA,MA/Ba;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAH;;AAAA,kBAAZjC,YAAY;AAAA;AAAA;AAAA,GAAlB,C,CAmCP;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAGA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;AAEO,IAAM4B,WAAW;AAAA;AAAA;AAAA;AAAA;AAAA,0BAAG;AAAA;AAAA;AAAA;AAAA;AAAA;AACvBC,YAAAA,MADuB,SACvBA,MADuB,EACfC,MADe,SACfA,MADe,EACPC,MADO,SACPA,MADO,EACCG,QADD,SACCA,QADD,EACWC,IADX,SACWA,IADX,EACiBC,OADjB,SACiBA,OADjB,EAEvBC,QAFuB,SAEvBA,QAFuB,EAEbL,IAFa,SAEbA,IAFa,EAEP1B,OAFO,SAEPA,OAFO,EAEEgB,IAFF,SAEEA,IAFF;AAAA;AAAA,2BAKXO,MALW;AAAA,8CAMV,aANU,wBASV,cATU,wBAYV,uBAZU,yBAeV,2BAfU;AAAA;;AAAA;AAAA;AAAA,mBAOC,qCAAWC,MAAX,EAAmBC,MAAnB,EAA2BC,IAA3B,EAAiCV,IAAjC,EAAuCa,IAAvC,CAPD;;AAAA;AAOXG,YAAAA,GAPW;AAAA;;AAAA;AAAA;AAAA,mBAUC,sCAAYR,MAAZ,EAAoBC,MAApB,EAA4BC,IAA5B,EAAkCG,IAAlC,EAAwCC,OAAxC,EAAiDd,IAAjD,EAAuDhB,OAAvD,CAVD;;AAAA;AAUXgC,YAAAA,GAVW;AAAA;;AAAA;AAAA;AAAA,mBAaC,wCAAcR,MAAd,EAAsBC,MAAtB,EAA8BC,IAA9B,EAAoCV,IAApC,CAbD;;AAAA;AAaXgB,YAAAA,GAbW;AAAA;;AAAA;AAAA;AAAA,mBAgBC,4CAAkBR,MAAlB,EAA0BC,MAA1B,EAAkCC,IAAlC,EAAwCV,IAAxC,CAhBD;;AAAA;AAgBXgB,YAAAA,GAhBW;AAAA;;AAAA;AAAA;;AAAA;AAAA,8CAqBZA,GArBY;;AAAA;AAAA;AAAA;AAuBnBpC,YAAAA,OAAO,CAACqC,KAAR,CAAc,SAAd,EAAyBV,MAAzB,EAAiC,OAAjC,EAA0CM,IAA1C,EAAgD,MAAhD;AAvBmB;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAH;;AAAA,kBAAXP,WAAW;AAAA;AAAA;AAAA,GAAjB;AA4BP;;;;;;;;;AAKO,IAAMY,oBAAoB;AAAA;AAAA;AAAA;AAAA;AAAA,0BAAG,kBAAOC,EAAP,EAAWT,IAAX;AAAA;AAAA;AAAA;AAAA;AAAA;AAC1BU,YAAAA,OAD0B,GAChB,+CADgB;AAE1BC,YAAAA,GAF0B,GAEpB,cAFoB;AAG1BC,YAAAA,UAH0B,GAGbC,kBAAkB,CAACC,IAAI,CAACC,MAAL,KAAgB,GAAjB,CAHL;AAI1BC,YAAAA,KAJ0B,GAIlBH,kBAAkB,CAACb,IAAD,CAJA,EAKhC;;AACMiB,YAAAA,QAN0B,0DAMiCP,OANjC,kBAMgDC,GANhD,iBAM0DF,EAN1D,yBAM2EG,UAN3E,mBAM8FI,KAN9F;AAQhC9C,YAAAA,OAAO,CAACuB,IAAR,CAAa,0BAAb;AACAvB,YAAAA,OAAO,CAACuB,IAAR,CAAawB,QAAb;AATgC;AAAA,mBAWnBC,kBAAMC,GAAN,CAAUF,QAAV,CAXmB;;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAH;;AAAA,kBAApBT,oBAAoB;AAAA;AAAA;AAAA,GAA1B","sourcesContent":["import axios from 'axios';\nimport { DateTime } from 'luxon';\nimport {\n    basicReply,\n    basicOption,\n    basicComments,\n    basicPostComments,\n} from '../bot/simpleBotController';\nimport { getStoreByPhone, getStoreData } from '../controllers/storesController';\nimport {\n    getOrderPending,\n    getLastUserOrder,\n    ORDERSTATUS_ACCEPTED,\n    ORDERSTATUS_FINISHED,\n    ORDERSTATUS_REJECTED,\n} from '../controllers/simpleOrdersController';\nimport { getOnePageData } from '../controllers/pagesController';\n\n/**\n * Receives the user and message from whatsapp and\n * returns a message from the system.\n * @param {*} args\n */\nexport const w_controller = async (args) => {\n    console.log('###### w_controller SIMPLE ######');\n    console.dir(args);\n    const { myId, message, userId, contactName, profileImg, quotedMsg } = args;\n    // If user is referencing a message (quotedMsg), insert it into processedMsg.\n    // Otherwise, processdMsg is the same message sent.\n    const processedMsg = quotedMsg ? quotedMsg + '\\n' + message : message;\n\n    const names = contactName.split(' ');\n    const first_name = names.shift();\n    const last_name = names.length >= 1 ? names.join(' ') : null;\n    const _profile_pic = profileImg && decodeURIComponent(profileImg.replace('https://web.whatsapp.com/pp?e=', ''));\n    const user = {\n        first_name: first_name,\n        last_name: last_name,\n        profile_pic: _profile_pic,\n    }\n\n\n    const store = await getStoreByPhone(myId);\n    if (store) {\n        console.info(`store name: ${store.name}`);\n        const { pageId } = store;\n\n        const result = await sendActions({\n            action: 'BASIC_UPDATE_POSTCOMMENTS',\n            pageID: pageId,\n            userID: userId,\n            text: processedMsg,\n            user: user,\n        });\n        return result;\n    }\n}\n\n// /**\n//  * Receives the user and message from whatsapp and\n//  * returns a message from the system.\n//  * @param {*} args\n//  */\n// export const w_controller = async (args) => {\n//     console.log('###### w_controller SIMPLE ######');\n//     console.dir(args);\n//     const { myId, message, userId, match, contactName, profileImg, quotedMsg } = args;\n//     // If user is referencing a message (quotedMsg), insert it into processedMsg.\n//     // Otherwise, processdMsg is the same message sent.\n//     const processedMsg = quotedMsg ? quotedMsg + '\\n' + message : message;\n\n//     const names = contactName.split(' ');\n//     const first_name = names.shift();\n//     const last_name = names.length >= 1 ? names.join(' ') : null;\n//     const _profile_pic = profileImg && decodeURIComponent(profileImg.replace('https://web.whatsapp.com/pp?e=', ''));\n//     const user = {\n//         first_name: first_name,\n//         last_name: last_name,\n//         profile_pic: _profile_pic,\n//     }\n\n\n//     const store = await getStoreByPhone(myId);\n//     if (store) {\n//         console.info(`store name: ${store.name}, match:${match}`);\n//         const { pageId } = store;\n\n//         // No option match, plain text.\n//         if (!match) {\n//             const pendingOrder = await getOrderPending({ pageId: pageId, userId: userId });\n//             // Found a pending order\n//             if (pendingOrder && pendingOrder.order) {\n//                 console.log(`pendingorder id:${pendingOrder.order.id} \n//                 waitingFor:${pendingOrder.order.waitingFor}\n//                 coments:${pendingOrder.order.comments}`);\n\n//                 let result;\n\n//                 if (pendingOrder.order.waitingFor === 'typed_comments') {\n//                     const oldComments = pendingOrder.order.comments;\n\n//                     // Order not yet accepted\n//                     if (pendingOrder.order.status < ORDERSTATUS_ACCEPTED) {\n//                         // concat old comments and the new comments\n//                         let updatedComents = oldComments ? oldComments + '\\n' + processedMsg : processedMsg;\n\n//                         result = await sendActions({\n//                             action: 'BASIC_UPDATE_COMMENTS',\n//                             pageID: pageId,\n//                             userID: userId,\n//                             text: updatedComents,\n//                             user: user,\n//                         });\n\n//                     } else { // Order already accepted\n//                         result = await sendActions({\n//                             action: 'BASIC_UPDATE_POSTCOMMENTS',\n//                             pageID: pageId,\n//                             userID: userId,\n//                             text: processedMsg,\n//                             user: user,\n//                         });\n//                     }\n//                 }\n//                 return result;\n//             } else { // No pending order found.\n//                 const page = await getOnePageData(pageId);\n//                 const store = await getStoreData(pageId);\n//                 // Get the last order from this customer.\n//                 const lastOrder = await getLastUserOrder({ pageId, userId, status: ORDERSTATUS_REJECTED });\n\n//                 if (lastOrder) {\n//                     console.log('>> Found lastOrder:', lastOrder.id);\n\n//                     const orderDay = DateTime.fromJSDate(lastOrder.createdAt).get('day');\n//                     const today = DateTime.local().get('day');\n\n//                     if (orderDay === today && lastOrder.status < ORDERSTATUS_FINISHED) {\n//                         console.log(' from today...');\n//                         return;\n//                     }\n//                 }\n//                 const tempoEntregar = store.delivery_time ? `(+ ou - ${store.delivery_time} min.)` : '';\n//                 const tempoRetirar = store.pickup_time ? `(+ ou - ${store.pickup_time} min.)` : '';\n\n//                 let replyText = page.firstResponseText.replace('$NAME', contactName);\n//                 replyText = replyText + '\\n\\n';\n\n//                 if (lastOrder && lastOrder.comments) {\n//                     replyText = replyText + 'Seu último pedido:\\n';\n//                     replyText = replyText + lastOrder.comments + '\\n';\n//                     replyText = replyText + 'Envie *REPETIR* para fazer o mesmo pedido OU envie os dados do pedido:\\n';\n\n//                     return await sendActions({\n//                         action: 'BASIC_OPTION',\n//                         pageID: pageId,\n//                         userID: userId,\n//                         text: replyText,\n//                         payload: lastOrder.comments,\n//                         data: 'REPETIR',\n//                         user: user,\n//                         message: processedMsg,\n//                     });\n//                 } else {\n//                     replyText = replyText + page.orderExample + '\\n';\n//                     replyText = replyText.replace('$TEMPOENTREGAR', tempoEntregar);\n//                     replyText = replyText.replace('$TEMPORETIRAR', tempoRetirar);\n\n//                     return await sendActions({\n//                         action: 'BASIC_REPLY',\n//                         pageID: pageId,\n//                         userID: userId,\n//                         text: replyText,\n//                         user: user,\n//                         data: processedMsg,\n//                     });\n//                 }\n\n//             }\n//         } else {\n//             if (match.hasOwnProperty('text') && match.text === 'REPETIR') {\n//                 return await sendActions({\n//                     action: 'BASIC_REPLY',\n//                     pageID: pageId,\n//                     userID: userId,\n//                     text: 'Ok, vamos repetir o pedido.',\n//                     user: user,\n//                     data: match.subText,\n//                 });\n//             }\n//         }\n//     } else {\n//         console.info(`### w_controller ### did not find store for myId: ${myId}`);\n//     }\n// }\n\nexport const sendActions = async ({\n    action, pageID, userID, multiple, data, payload,\n    location, text, message, user }) => {\n    try {\n        let out;\n        switch (action) {\n            case 'BASIC_REPLY':\n                out = await basicReply(pageID, userID, text, user, data);\n                break;\n            case 'BASIC_OPTION':\n                out = await basicOption(pageID, userID, text, data, payload, user, message);\n                break;\n            case 'BASIC_UPDATE_COMMENTS':\n                out = await basicComments(pageID, userID, text, user);\n                break;\n            case 'BASIC_UPDATE_POSTCOMMENTS':\n                out = await basicPostComments(pageID, userID, text, user);\n                break;\n            default:\n                break;\n        }\n        return out;\n    } catch (sendActionsErr) {\n        console.error('action:', action, 'data:', data, 'err:', sendActionsErr);\n        throw sendActionsErr;\n    }\n}\n\n/**\n * Used in waboxapp\n * @param {*} to\n * @param {*} text\n */\nexport const waboxapp_sendMessage = async (to, text) => {\n    const myToken = '3207ecb3e9815b97c7efea3f45e7f8205c646bc16cd19';\n    const uid = '554499485760';\n    const custom_uid = encodeURIComponent(Math.random() * 100);\n    const qText = encodeURIComponent(text);\n    // eslint-disable-next-line max-len\n    const waboxApp = `https://www.waboxapp.com/api/send/chat?token=${myToken}&uid=${uid}&to=${to}&custom_uid=${custom_uid}&text=${qText}`;\n\n    console.info('**** Ready to send: ****');\n    console.info(waboxApp);\n\n    return await axios.get(waboxApp);\n}\n"],"file":"whatSimpleController.js"}