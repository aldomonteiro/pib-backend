{"version":3,"sources":["../../../src/api/whatsapp/whatSimpleController.js"],"names":["w_controller","args","console","info","myId","message","userId","match","contactName","profileImg","names","split","first_name","shift","last_name","length","join","_profile_pic","decodeURIComponent","replace","user","profile_pic","store","name","pageId","pendingOrder","order","log","id","waitingFor","addrData","manual_addres","formattedAddress","sendActions","action","pageID","userID","result","oldComments","comments","status","ORDERSTATUS_ACCEPTED","text","updatedComents","page","lastOrder","orderDay","DateTime","fromJSDate","createdAt","get","today","local","ORDERSTATUS_FINISHED","tempoEntregar","delivery_time","tempoRetirar","pickup_time","replyText","firstResponseText","payload","data","orderExample","hasOwnProperty","subText","multiple","location","out","error","waboxapp_sendMessage","to","myToken","uid","custom_uid","encodeURIComponent","Math","random","qText","waboxApp","axios"],"mappings":"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","sourcesContent":["import axios from 'axios';\nimport { DateTime } from 'luxon';\nimport {\n    basicReply,\n    basicOption,\n    basicComments,\n    basicPostComments,\n} from '../bot/botController';\nimport { getStoreByPhone, getStoreData } from '../controllers/storesController';\nimport { getOrderPending, getLastUserOrder, ORDERSTATUS_ACCEPTED, ORDERSTATUS_FINISHED } from '../controllers/ordersController';\nimport { getOnePageData } from '../controllers/pagesController';\n\n/**\n * Receives the user and message from whatsapp and\n * returns a message from the system.\n * @param {*} args\n */\nexport const w_controller = async (args) => {\n    console.info('###### w_controller SIMPLE ######');\n    console.info(args);\n    const { myId, message, userId, match, contactName, profileImg } = args;\n\n    const names = contactName.split(' ');\n    const first_name = names.shift();\n    const last_name = names.length >= 1 ? names.join(' ') : null;\n    const _profile_pic = profileImg && decodeURIComponent(profileImg.replace('https://web.whatsapp.com/pp?e=', ''));\n    const user = {\n        first_name: first_name,\n        last_name: last_name,\n        profile_pic: _profile_pic,\n    }\n\n    const store = await getStoreByPhone(myId);\n    if (store) {\n        console.info(`store name: ${store.name}, match:${match}`);\n        const { pageId } = store;\n\n        if (!match) {\n            const pendingOrder = await getOrderPending({ pageId: pageId, userId: userId });\n            if (pendingOrder && pendingOrder.order) {\n                console.log(`pendingorder id:${pendingOrder.order.id} \n                waitingFor:${pendingOrder.order.waitingFor}`);\n\n                let result;\n\n                if (pendingOrder.order.waitingFor === 'typed_address') {\n                    const addrData = {\n                        manual_addres: true,\n                        formattedAddress: message,\n                    }\n                    result = await sendActions({\n                        action: 'CONFIRM_ADDRESS',\n                        pageID: pageId, userID: userId, addrData, user,\n                    });\n                } else if (pendingOrder.order.waitingFor === 'typed_comments') {\n                    const oldComments = pendingOrder.order.comments;\n\n                    if (pendingOrder.order.status >= ORDERSTATUS_ACCEPTED) {\n                        result = await sendActions({\n                            action: 'BASIC_UPDATE_POSTCOMMENTS',\n                            pageID: pageId,\n                            userID: userId,\n                            text: message,\n                            user: user,\n                        });\n\n                    } else {\n\n                        // concat old comments and the new comments\n                        let updatedComents = oldComments ? oldComments + '\\n' + message : message;\n\n                        result = await sendActions({\n                            action: 'BASIC_UPDATE_COMMENTS',\n                            pageID: pageId,\n                            userID: userId,\n                            text: updatedComents,\n                            user: user,\n                        });\n                    }\n                }\n                return result;\n            } else {\n                const page = await getOnePageData(pageId);\n                const store = await getStoreData(pageId);\n                // Get the last order from this customer.\n                const lastOrder = await getLastUserOrder({ pageId, userId });\n\n                if (lastOrder) {\n                    console.log('>> Found lastOrder:', lastOrder.id);\n\n                    const orderDay = DateTime.fromJSDate(lastOrder.createdAt).get('day');\n                    const today = DateTime.local().get('day');\n\n                    if (orderDay === today && lastOrder.status < ORDERSTATUS_FINISHED) {\n                        console.log(' from today...');\n                        return;\n                    }\n                }\n                const tempoEntregar = store.delivery_time ? `(+ ou - ${store.delivery_time} min.)` : '';\n                const tempoRetirar = store.pickup_time ? `(+ ou - ${store.pickup_time} min.)` : '';\n\n                let replyText = page.firstResponseText.replace('$NAME', contactName);\n                replyText = replyText + '\\n\\n';\n\n                if (lastOrder && lastOrder.comments) {\n                    replyText = replyText + 'Seu último pedido:\\n';\n                    replyText = replyText + lastOrder.comments + '\\n';\n                    replyText = replyText + 'Envie *REPETIR* para fazer o mesmo pedido OU envie os dados do pedido:\\n';\n\n                    return await sendActions({\n                        action: 'BASIC_OPTION',\n                        pageID: pageId,\n                        userID: userId,\n                        text: replyText,\n                        payload: lastOrder.comments,\n                        data: 'REPETIR',\n                        user: user,\n                    });\n                } else {\n                    replyText = replyText + page.orderExample + '\\n';\n                    replyText = replyText.replace('$TEMPOENTREGAR', tempoEntregar);\n                    replyText = replyText.replace('$TEMPORETIRAR', tempoRetirar);\n\n                    return await sendActions({\n                        action: 'BASIC_REPLY',\n                        pageID: pageId,\n                        userID: userId,\n                        text: replyText,\n                        user: user,\n                    });\n                }\n\n            }\n        } else {\n            if (match.hasOwnProperty('text') && match.text === 'REPETIR') {\n                return await sendActions({\n                    action: 'BASIC_REPLY',\n                    pageID: pageId,\n                    userID: userId,\n                    text: 'Ok, vamos repetir o pedido.',\n                    user: user,\n                    data: match.subText,\n                });\n            }\n        }\n    } else {\n        console.info(`### w_controller ### did not find store for myId: ${myId}`);\n    }\n}\n\nexport const sendActions = async ({\n    action, pageID, userID, multiple, data, payload,\n    location, text, addrData, user }) => {\n    try {\n        let out;\n        switch (action) {\n            case 'BASIC_REPLY':\n                out = await basicReply(pageID, userID, text, user, data);\n                break;\n            case 'BASIC_OPTION':\n                out = await basicOption(pageID, userID, text, data, payload, user);\n                break;\n            case 'BASIC_UPDATE_COMMENTS':\n                out = await basicComments(pageID, userID, text, user);\n                break;\n            case 'BASIC_UPDATE_POSTCOMMENTS':\n                out = await basicPostComments(pageID, userID, text, user);\n                break;\n            default:\n                break;\n        }\n        return out;\n    } catch (sendActionsErr) {\n        console.error('action:', action, 'data:', data, 'err:', sendActionsErr);\n        throw sendActionsErr;\n    }\n}\n\n/**\n * Used in waboxapp\n * @param {*} to\n * @param {*} text\n */\nexport const waboxapp_sendMessage = async (to, text) => {\n    const myToken = '3207ecb3e9815b97c7efea3f45e7f8205c646bc16cd19';\n    const uid = '554499485760';\n    const custom_uid = encodeURIComponent(Math.random() * 100);\n    const qText = encodeURIComponent(text);\n    // eslint-disable-next-line max-len\n    const waboxApp = `https://www.waboxapp.com/api/send/chat?token=${myToken}&uid=${uid}&to=${to}&custom_uid=${custom_uid}&text=${qText}`;\n\n    console.info('**** Ready to send: ****');\n    console.info(waboxApp);\n\n    return await axios.get(waboxApp);\n}\n"],"file":"whatSimpleController.js"}