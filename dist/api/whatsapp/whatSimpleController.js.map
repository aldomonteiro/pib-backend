{"version":3,"sources":["../../../src/api/whatsapp/whatSimpleController.js"],"names":["w_controller","args","console","info","myId","message","userId","match","location","contactName","profileImg","names","split","first_name","shift","last_name","length","join","_profile_pic","decodeURIComponent","replace","user","profile_pic","store","name","pageId","pendingOrder","order","log","id","waitingFor","addrData","manual_addres","formattedAddress","sendActions","action","pageID","userID","result","oldComments","comments","updatedComents","text","page","lastOrder","orderDay","DateTime","fromJSDate","confirmed_at","get","today","local","tempoEntregar","delivery_time","tempoRetirar","pickup_time","replyText","firstResponseText","payload","data","orderExample","hasOwnProperty","subText","multiple","out","error","waboxapp_sendMessage","to","myToken","uid","custom_uid","encodeURIComponent","Math","random","qText","waboxApp","axios"],"mappings":"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","sourcesContent":["import axios from 'axios';\nimport { DateTime } from 'luxon';\nimport {\n    basicReply,\n    basicOption,\n    basicComments,\n} from '../bot/botController';\nimport { getStoreByPhone, getStoreData } from '../controllers/storesController';\nimport { getOrderPending, getLastUserOrder } from '../controllers/ordersController';\nimport { getOnePageData } from '../controllers/pagesController';\n\n/**\n * Receives the user and message from whatsapp and\n * returns a message from the system.\n * @param {*} args\n */\nexport const w_controller = async (args) => {\n    console.info('###### w_controller SIMPLE ######');\n    console.info(args);\n    const { myId, message, userId, match, location, contactName, profileImg } = args;\n\n    const names = contactName.split(' ');\n    const first_name = names.shift();\n    const last_name = names.length >= 1 ? names.join(' ') : null;\n    const _profile_pic = profileImg && decodeURIComponent(profileImg.replace('https://web.whatsapp.com/pp?e=', ''));\n    const user = {\n        first_name: first_name,\n        last_name: last_name,\n        profile_pic: _profile_pic,\n    }\n\n    const store = await getStoreByPhone(myId);\n    if (store) {\n        console.info(`store name: ${store.name}, match:${match}`);\n        const { pageId } = store;\n\n        if (!match) {\n            const pendingOrder = await getOrderPending({ pageId: pageId, userId: userId });\n            if (pendingOrder && pendingOrder.order) {\n                console.log(`pendingorder id:${pendingOrder.order.id} \n                waitingFor:${pendingOrder.order.waitingFor}`);\n\n                let result;\n\n                if (pendingOrder.order.waitingFor === 'typed_address') {\n                    const addrData = {\n                        manual_addres: true,\n                        formattedAddress: message,\n                    }\n                    result = await sendActions({\n                        action: 'CONFIRM_ADDRESS',\n                        pageID: pageId, userID: userId, addrData, user,\n                    });\n                } else if (pendingOrder.order.waitingFor === 'typed_comments') {\n                    const oldComments = pendingOrder.order.comments;\n\n                    // concat old comments and the new comments\n                    let updatedComents = oldComments ? oldComments + '\\n' + message : message;\n\n                    result = await sendActions({\n                        action: 'BASIC_UPDATE_COMMENTS',\n                        pageID: pageId,\n                        userID: userId,\n                        text: updatedComents,\n                        user: user,\n                    });\n                }\n                return result;\n            } else {\n                const page = await getOnePageData(pageId);\n                const store = await getStoreData(pageId);\n                // Get the last order from this customer.\n                const lastOrder = await getLastUserOrder({ pageId, userId });\n\n                if (lastOrder) {\n                    console.log('>> Found lastOrder:', lastOrder.id);\n\n                    const orderDay = DateTime.fromJSDate(lastOrder.confirmed_at).get('day');\n                    const today = DateTime.local().get('day');\n\n                    if (orderDay === today) {\n                        console.log(' from today...');\n                        return;\n                    }\n                }\n                const tempoEntregar = store.delivery_time ? `(+ ou - ${store.delivery_time} min.)` : '';\n                const tempoRetirar = store.pickup_time ? `(+ ou - ${store.pickup_time} min.)` : '';\n\n                let replyText = page.firstResponseText.replace('$NAME', contactName);\n                replyText = replyText + '\\n\\n';\n\n                if (lastOrder && lastOrder.comments) {\n                    replyText = replyText + 'Seu último pedido:\\n';\n                    replyText = replyText + lastOrder.comments + '\\n';\n                    replyText = replyText + 'Envie *REPETIR* para fazer o mesmo pedido OU envie os dados do pedido:\\n';\n\n                    return await sendActions({\n                        action: 'BASIC_OPTION',\n                        pageID: pageId,\n                        userID: userId,\n                        text: replyText,\n                        payload: lastOrder.comments,\n                        data: 'REPETIR',\n                        user: user,\n                    });\n                } else {\n                    replyText = replyText + page.orderExample + '\\n';\n                    replyText = replyText.replace('$TEMPOENTREGAR', tempoEntregar);\n                    replyText = replyText.replace('$TEMPORETIRAR', tempoRetirar);\n\n                    return await sendActions({\n                        action: 'BASIC_REPLY',\n                        pageID: pageId,\n                        userID: userId,\n                        text: replyText,\n                        user: user,\n                    });\n                }\n\n            }\n        } else {\n            if (match.hasOwnProperty('text') && match.text === 'REPETIR') {\n                return await sendActions({\n                    action: 'BASIC_REPLY',\n                    pageID: pageId,\n                    userID: userId,\n                    text: 'Ok, vamos repetir o pedido.',\n                    user: user,\n                    data: match.subText,\n                });\n            }\n        }\n    } else {\n        console.info(`### w_controller ### did not find store for myId: ${myId}`);\n    }\n}\n\nexport const sendActions = async ({\n    action, pageID, userID, multiple, data, payload,\n    location, text, addrData, user }) => {\n    try {\n        let out;\n        switch (action) {\n            case 'BASIC_REPLY':\n                out = await basicReply(pageID, userID, text, user, data);\n                break;\n            case 'BASIC_OPTION':\n                out = await basicOption(pageID, userID, text, data, payload, user);\n                break;\n            case 'BASIC_UPDATE_COMMENTS':\n                out = await basicComments(pageID, userID, text, user);\n                break;\n            default:\n                break;\n        }\n        return out;\n    } catch (sendActionsErr) {\n        console.error('action:', action, 'data:', data, 'err:', sendActionsErr);\n        throw sendActionsErr;\n    }\n}\n\n/**\n * Used in waboxapp\n * @param {*} to\n * @param {*} text\n */\nexport const waboxapp_sendMessage = async (to, text) => {\n    const myToken = '3207ecb3e9815b97c7efea3f45e7f8205c646bc16cd19';\n    const uid = '554499485760';\n    const custom_uid = encodeURIComponent(Math.random() * 100);\n    const qText = encodeURIComponent(text);\n    // eslint-disable-next-line max-len\n    const waboxApp = `https://www.waboxapp.com/api/send/chat?token=${myToken}&uid=${uid}&to=${to}&custom_uid=${custom_uid}&text=${qText}`;\n\n    console.info('**** Ready to send: ****');\n    console.info(waboxApp);\n\n    return await axios.get(waboxApp);\n}\n"],"file":"whatSimpleController.js"}